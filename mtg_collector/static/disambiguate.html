<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Disambiguate - Card Ingest</title>
<link href="https://cdn.jsdelivr.net/npm/keyrune@latest/css/keyrune.min.css" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: #1a1a2e;
  color: #e0e0e0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  min-height: 100vh;
}
header {
  background: #16213e;
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  border-bottom: 2px solid #0f3460;
}
header h1 { font-size: 1.1rem; color: #e94560; }
header a { color: #888; text-decoration: none; font-size: 0.8rem; }
header a:hover { color: #e94560; }

button {
  padding: 8px 16px;
  border: 1px solid #0f3460;
  border-radius: 6px;
  background: #e94560;
  border-color: #e94560;
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  font-size: 0.9rem;
}
button:hover { background: #c73651; }
button:disabled { opacity: 0.5; cursor: not-allowed; }
button.secondary { background: #333; border-color: #555; }
button.secondary:hover { background: #444; }

.empty-state {
  text-align: center;
  padding: 80px 40px;
  color: #555;
}
.empty-state h2 { color: #888; margin-bottom: 12px; }

.status-summary {
  margin: 12px 16px 0;
  font-size: 0.85rem;
  color: #888;
}

/* Per-card disambiguation block */
.card-block {
  margin: 12px 16px;
  background: #16213e;
  border: 1px solid #0f3460;
  border-radius: 8px;
  overflow: hidden;
  transition: opacity 0.3s;
}
.card-block.resolved {
  opacity: 0;
  max-height: 0;
  margin: 0 16px;
  overflow: hidden;
  transition: opacity 0.3s, max-height 0.3s, margin 0.3s;
}

.card-header {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 10px 12px;
  background: #0d1117;
  border-bottom: 1px solid #0f3460;
}
.card-header .crop-thumb {
  width: 280px;
  height: 392px;
  background: #0d1117;
  border-radius: 4px;
  overflow: hidden;
  flex-shrink: 0;
  position: relative;
}
.card-header .crop-thumb img {
  position: absolute;
  transform-origin: 0 0;
}
.card-header .right-col {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.card-header .card-meta h3 {
  color: #e94560;
  font-size: 0.95rem;
  margin-bottom: 2px;
}
.card-header .card-meta .meta-line {
  font-size: 0.8rem;
  color: #888;
  margin-bottom: 1px;
}
.card-header .card-meta .image-source {
  font-size: 0.7rem;
  color: #555;
  margin-top: 2px;
}

.card-header .actions-col {
  display: flex;
  gap: 6px;
  align-items: center;
  flex-wrap: wrap;
}
.card-header .actions-col .finish-select {
  padding: 4px 8px;
  border: 1px solid #0f3460;
  border-radius: 4px;
  background: #1a1a2e;
  color: #e0e0e0;
  font-size: 0.8rem;
}
@media (max-width: 600px) {
  .card-header .crop-thumb {
    width: 140px;
    height: 196px;
  }
}

.search-row {
  display: flex;
  gap: 6px;
  padding: 6px 12px;
  border-bottom: 1px solid #0f3460;
}
.search-row input {
  flex: 1;
  padding: 5px 8px;
  border-radius: 4px;
  border: 1px solid #0f3460;
  background: #0d1117;
  color: #e0e0e0;
  font-size: 0.85rem;
}
.search-row button {
  padding: 5px 12px;
  font-size: 0.8rem;
}

.candidates-list {
  max-height: 1200px;
  overflow-y: auto;
  padding: 4px;
}
.candidate-row {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 3px 6px;
  border: 2px solid transparent;
  border-radius: 5px;
  margin-bottom: 2px;
  cursor: pointer;
  transition: border-color 0.15s, background 0.15s;
}
.candidate-row:hover { background: #1a1a3e; border-color: #0f3460; }
.candidate-row.selected { border-color: #e94560; background: #1a1a3e; }

.candidate-row .set-icon {
  font-size: 1.8rem;
  width: 42px; height: 42px; line-height: 42px;
  text-align: center; flex-shrink: 0;
  background: #efefef; border-radius: 4px;
}
.candidate-row .card-name {
  font-weight: 600; font-size: 0.8rem;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  flex: 1; min-width: 0;
}
.candidate-row .card-set-name {
  font-size: 0.7rem; color: #888;
  white-space: nowrap; flex-shrink: 0;
  max-width: 160px; overflow: hidden; text-overflow: ellipsis;
}
.candidate-row .card-price {
  font-size: 0.65rem; color: #4caf50;
  background: rgba(76, 175, 80, 0.12);
  padding: 2px 5px; border-radius: 3px;
  flex-shrink: 0; white-space: nowrap;
}
.candidate-row .card-img-crop {
  width: 110px; height: 50px;
  object-fit: cover; object-position: top center;
  border-radius: 3px; flex-shrink: 0;
}

/* Grid mode for many candidates */
.candidates-list.grid-mode {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  gap: 4px;
}
@media (max-width: 600px) {
  .candidates-list.grid-mode {
    grid-template-columns: repeat(4, 1fr);
  }
}
.candidates-list.grid-mode .candidate-row {
  flex-direction: column; padding: 3px; gap: 3px; align-items: center;
  position: relative;
}
.candidates-list.grid-mode .candidate-row .set-icon {
  position: absolute; top: 3px; left: 3px; z-index: 1;
  font-size: 1.2rem; width: 28px; height: 28px; line-height: 28px;
  border: 2px solid #0f3460;
}
.candidates-list.grid-mode .card-img-grid {
  width: 100%; aspect-ratio: 63 / 44;
  object-fit: cover; object-position: top center; border-radius: 3px;
}

.spinner {
  display: inline-block;
  width: 14px; height: 14px;
  border: 2px solid #555;
  border-top-color: #e94560;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  vertical-align: middle;
  margin-right: 6px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Photo modal */
.photo-modal {
  position: fixed;
  inset: 0;
  z-index: 1000;
  background: rgba(0,0,0,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: zoom-out;
}
.photo-modal img {
  max-width: 95vw;
  max-height: 95vh;
  object-fit: contain;
  border-radius: 6px;
}
.card-header .crop-thumb { cursor: zoom-in; }
</style>
<style id="dynamic-settings-style"></style>
</head>
<body>

<header>
  <h1><a href="/" style="color:inherit;text-decoration:none">Disambiguate</a></h1>
  <a href="/">Home</a>
  <a href="/upload">Upload</a>
  <a href="/recent">Recent</a>
  <span id="status-bar" style="margin-left:auto;font-size:0.85rem;color:#888;"></span>
</header>

<div id="empty-state" class="empty-state" style="display:none">
  <h2>No cards to disambiguate</h2>
  <p><a href="/upload" style="color:#e94560">Upload some photos</a> &mdash; cards are processed automatically</p>
</div>

<div class="status-summary" id="status-summary"></div>
<div id="cards-container"></div>

<script>
let _settings = {};
let confirmedCount = 0;
let skippedCount = 0;
let pendingCards = [];

const KEYRUNE_FALLBACKS = {
  tsb: 'tsp', pspm: 'spm', cst: 'csp',
};
function keyruneSetCode(code) {
  const lc = (code || '').toLowerCase();
  return KEYRUNE_FALLBACKS[lc] || lc;
}

function applySettings() {
  const style = document.getElementById('dynamic-settings-style');
  let css = '';
  if (_settings.image_display === 'contain') {
    css += '.card-img-crop { object-fit: contain !important; object-position: center !important; }\n';
    css += '.card-img-grid { object-fit: contain !important; object-position: center !important; }\n';
  }
  if (_settings.icon_background === 'none') {
    css += '.candidate-row .set-icon { color: transparent !important; }\n';
  }
  style.textContent = css;
}
fetch('/api/settings').then(r => r.json()).then(s => { _settings = s; applySettings(); });

function escapeHtml(s) {
  return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

async function loadPendingCards() {
  const resp = await fetch('/api/ingest2/pending-disambiguation');
  pendingCards = await resp.json();

  const container = document.getElementById('cards-container');
  const empty = document.getElementById('empty-state');
  const summary = document.getElementById('status-summary');

  if (pendingCards.length === 0) {
    container.innerHTML = '';
    empty.style.display = 'block';
    summary.textContent = '';
    return;
  }
  empty.style.display = 'none';
  summary.textContent = `${pendingCards.length} card(s) pending disambiguation`;

  container.innerHTML = '';
  for (let i = 0; i < pendingCards.length; i++) {
    const pc = pendingCards[i];
    container.appendChild(buildCardBlock(pc, i));
  }
}

function buildCardBlock(pc, idx) {
  const block = document.createElement('div');
  block.className = 'card-block';
  block.id = `card-block-${idx}`;
  block.dataset.imageId = pc.image_id;
  block.dataset.cardIdx = pc.card_idx;

  const card = pc.card_info || {};
  const name = card.name || '(Unknown)';
  const metaLines = [];
  if (card.mana_cost) metaLines.push(card.mana_cost.replace(/\{|\}/g, ''));
  if (card.type) {
    let typeLine = card.type;
    if (card.subtype) typeLine += ` — ${card.subtype}`;
    metaLines.push(typeLine);
  }
  if (card.rules_text) metaLines.push(card.rules_text);
  if (card.power != null || card.toughness != null) metaLines.push(`${card.power ?? '?'}/${card.toughness ?? '?'}`);
  const idParts = [];
  if (card.set_code) idParts.push(card.set_code.toUpperCase());
  if (card.collector_number) idParts.push(`#${card.collector_number}`);
  if (card.artist) idParts.push(card.artist);
  if (idParts.length) metaLines.push(idParts.join(' · '));

  block.innerHTML = `
    <div class="card-header">
      <div class="crop-thumb" id="crop-${idx}"></div>
      <div class="right-col">
        <div class="card-meta">
          <h3>${escapeHtml(name)}</h3>
          ${metaLines.map(l => `<div class="meta-line">${escapeHtml(l)}</div>`).join('')}
          <div class="image-source">${escapeHtml(pc.image_filename)}</div>
        </div>
        <div class="actions-col">
          <button class="confirm-btn" data-idx="${idx}" disabled>Confirm</button>
          <select class="finish-select" data-idx="${idx}">
            <option value="nonfoil">Nonfoil</option>
            <option value="foil">Foil</option>
            <option value="etched">Etched</option>
          </select>
          <button class="secondary skip-btn" data-idx="${idx}" style="font-size:0.8rem;padding:4px 10px;">Skip</button>
        </div>
      </div>
    </div>
    <div class="search-row">
      <input type="text" class="search-input" data-idx="${idx}" placeholder="Search by card name..." value="${escapeHtml(name)}">
      <button class="search-btn secondary" data-idx="${idx}">Search</button>
    </div>
    <div class="candidates-list" id="candidates-${idx}"></div>
  `;

  // Set up crop thumbnail
  setTimeout(() => setupCropThumb(idx, pc), 0);

  // Render candidates
  setTimeout(() => {
    renderCandidates(idx, pc.candidates || []);
  }, 0);

  // Event listeners
  block.querySelector('.confirm-btn').addEventListener('click', () => confirmCard(idx));
  block.querySelector('.skip-btn').addEventListener('click', () => skipCard(idx));
  block.querySelector('.search-btn').addEventListener('click', () => searchCard(idx));
  block.querySelector('.search-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') searchCard(idx);
  });

  return block;
}

function setupCropThumb(idx, pc) {
  const container = document.getElementById(`crop-${idx}`);
  if (!container) return;
  const crop = pc.crop;
  const imageFilename = pc.image_filename;

  const imgSrc = `/api/ingest/image/${imageFilename}`;
  const img = document.createElement('img');
  img.src = imgSrc;
  container.appendChild(img);

  container.addEventListener('click', () => showPhotoModal(imgSrc));

  img.onload = () => {
    const cw = container.clientWidth;
    const ch = container.clientHeight;
    if (crop && crop.w > 0 && crop.h > 0) {
      const scale = Math.min(cw / crop.w, ch / crop.h);
      const tx = (cw / 2) - (crop.x + crop.w / 2) * scale;
      const ty = (ch / 2) - (crop.y + crop.h / 2) * scale;
      img.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
    } else {
      const scale = Math.min(cw / img.naturalWidth, ch / img.naturalHeight);
      img.style.transform = `scale(${scale})`;
    }
  };
}

function renderCandidates(idx, candidates) {
  const list = document.getElementById(`candidates-${idx}`);
  if (!list) return;
  list.innerHTML = '';

  if (!candidates.length) {
    list.innerHTML = '<div style="padding:12px;color:#888;text-align:center;font-size:0.85rem;">No candidates found</div>';
    return;
  }

  list.className = 'candidates-list grid-mode';

  for (const c of candidates) {
    const row = document.createElement('div');
    row.className = 'candidate-row';
    row.dataset.scryfallId = c.scryfall_id;
    row.dataset.parentIdx = idx;

    const setCode = keyruneSetCode(c.set_code);
    const rarityClass = `ss-${c.rarity || 'common'}`;
    const sources = (_settings.price_sources || 'tcg,ck').split(',');
    const showPrice = sources.includes('tcg') && c.price;

    row.innerHTML = `
      <i class="ss ss-${setCode} ${rarityClass} ss-grad ss-fw set-icon"></i>
      ${c.image_uri ? `<img class="card-img-grid" src="${c.image_uri}" loading="lazy">` : `<div style="width:100%;aspect-ratio:63/88;background:#0d1117;border-radius:3px;"></div>`}
    `;
    row.title = `${c.name} — ${c.set_name}${showPrice ? ' ($' + c.price + ')' : ''}`;

    row.addEventListener('click', () => {
      // Deselect others in same block
      list.querySelectorAll('.candidate-row').forEach(r => r.classList.remove('selected'));
      row.classList.add('selected');

      // Store selection
      const block = document.getElementById(`card-block-${idx}`);
      block._selectedCandidate = c;
      block.querySelector('.confirm-btn').disabled = false;

      // Auto-set finish
      const finishSel = block.querySelector('.finish-select');
      if (c.foil && !(c.finishes || []).includes('nonfoil')) {
        finishSel.value = 'foil';
      } else {
        finishSel.value = 'nonfoil';
      }
    });

    list.appendChild(row);
  }
}

async function confirmCard(idx) {
  const block = document.getElementById(`card-block-${idx}`);
  const candidate = block._selectedCandidate;
  if (!candidate) return;

  const imageId = parseInt(block.dataset.imageId);
  const cardIdx = parseInt(block.dataset.cardIdx);
  const finish = block.querySelector('.finish-select').value;

  const btn = block.querySelector('.confirm-btn');
  btn.disabled = true;
  btn.textContent = '...';

  const resp = await fetch('/api/ingest2/confirm', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      image_id: imageId,
      card_idx: cardIdx,
      scryfall_id: candidate.scryfall_id,
      finish,
    }),
  });
  const data = await resp.json();

  if (data.ok) {
    confirmedCount++;
    updateStatusBar();
    removeBlock(block);
  }
}

async function skipCard(idx) {
  const block = document.getElementById(`card-block-${idx}`);
  const imageId = parseInt(block.dataset.imageId);
  const cardIdx = parseInt(block.dataset.cardIdx);

  const btn = block.querySelector('.skip-btn');
  btn.disabled = true;

  await fetch('/api/ingest2/skip', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ image_id: imageId, card_idx: cardIdx }),
  });

  skippedCount++;
  updateStatusBar();
  removeBlock(block);
}

async function searchCard(idx) {
  const block = document.getElementById(`card-block-${idx}`);
  const input = block.querySelector('.search-input');
  const query = input.value.trim();
  if (!query) return;

  const btn = block.querySelector('.search-btn');
  btn.disabled = true;
  btn.textContent = '...';

  const imageId = parseInt(block.dataset.imageId);
  const cardIdx = parseInt(block.dataset.cardIdx);

  const resp = await fetch('/api/ingest2/search-card', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ image_id: imageId, card_idx: cardIdx, query }),
  });
  const data = await resp.json();

  btn.disabled = false;
  btn.textContent = 'Search';

  block._selectedCandidate = null;
  block.querySelector('.confirm-btn').disabled = true;
  renderCandidates(idx, data.candidates || []);
}

function removeBlock(block) {
  block.classList.add('resolved');
  setTimeout(() => block.remove(), 350);

  // Check if all done
  setTimeout(() => {
    const remaining = document.querySelectorAll('.card-block:not(.resolved)');
    if (remaining.length === 0) {
      document.getElementById('status-summary').textContent =
        `All done! Confirmed ${confirmedCount}, skipped ${skippedCount}.`;
      document.getElementById('empty-state').style.display = 'block';
      document.querySelector('#empty-state h2').textContent = 'All done!';
      document.querySelector('#empty-state p').innerHTML =
        `Confirmed ${confirmedCount} card(s), skipped ${skippedCount}. ` +
        `<a href="/collection" style="color:#e94560">View Collection</a>`;
    } else {
      document.getElementById('status-summary').textContent =
        `${remaining.length} card(s) remaining`;
    }
  }, 400);
}

function updateStatusBar() {
  document.getElementById('status-bar').textContent =
    `Confirmed: ${confirmedCount} | Skipped: ${skippedCount}`;
}

function showPhotoModal(imageSrc) {
  const modal = document.createElement('div');
  modal.className = 'photo-modal';
  modal.innerHTML = `<img src="${imageSrc}">`;
  modal.addEventListener('click', () => modal.remove());
  document.body.appendChild(modal);
}

// ── Init ──
loadPendingCards();
</script>
</body>
</html>
