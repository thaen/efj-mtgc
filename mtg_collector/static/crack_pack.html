<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Crack-a-Pack</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: #1a1a2e;
  color: #e0e0e0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  min-height: 100vh;
}

header {
  background: #16213e;
  padding: 16px 24px;
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
  border-bottom: 2px solid #0f3460;
}

header h1 {
  font-size: 1.3rem;
  color: #e94560;
  margin-right: 16px;
  white-space: nowrap;
}

.controls {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

select, button, .set-search-input {
  padding: 8px 14px;
  border: 1px solid #0f3460;
  border-radius: 6px;
  background: #1a1a2e;
  color: #e0e0e0;
  font-size: 0.9rem;
  cursor: pointer;
}

select:focus, button:focus, .set-search-input:focus { outline: 2px solid #e94560; }

.set-search-wrap {
  position: relative;
}

.set-search-input {
  width: 260px;
  cursor: text;
}

.set-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  max-height: 300px;
  overflow-y: auto;
  background: #1a1a2e;
  border: 1px solid #0f3460;
  border-top: none;
  border-radius: 0 0 6px 6px;
  z-index: 100;
  list-style: none;
}

.set-dropdown.open { display: block; }

.set-dropdown li {
  padding: 6px 14px;
  font-size: 0.9rem;
  cursor: pointer;
}

.set-dropdown li:hover, .set-dropdown li.active {
  background: #0f3460;
}

.product-radios {
  display: flex;
  gap: 6px;
  align-items: center;
  flex-wrap: wrap;
}

.product-radios label {
  display: inline-block;
  padding: 6px 14px;
  border: 1px solid #0f3460;
  border-radius: 20px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
  user-select: none;
}

.product-radios input[type="radio"] { display: none; }
.product-radios input[type="checkbox"] { display: none; }

.product-radios input[type="radio"]:checked + label,
.product-radios input[type="checkbox"]:checked + label {
  background: #e94560;
  border-color: #e94560;
  color: #fff;
}

button {
  background: #e94560;
  border-color: #e94560;
  color: #fff;
  font-weight: 600;
}

button:hover { background: #c73651; }
button:disabled { opacity: 0.4; cursor: not-allowed; }

#status {
  font-size: 0.85rem;
  color: #888;
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 12px;
}

.prices-status {
  font-size: 0.75rem;
  color: #666;
  cursor: pointer;
  user-select: none;
}

.prices-status:hover { color: #aaa; }

.prices-status.loading { color: #e94560; }

.main {
  display: flex;
  gap: 0;
  min-height: calc(100vh - 64px);
}

.pack-area {
  flex: 1;
  padding: 24px;
}

.pack-area h2 {
  font-size: 1rem;
  color: #888;
  margin-bottom: 16px;
}

.pack-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-content: flex-start;
  height: calc(100vh - 150px);
}

.card-slot {
  position: relative;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s;
  height: calc((100vh - 174px) / var(--pack-rows, 2));
  perspective: 800px;
}

.card-slot.zoomed {
  transform: scale(1.8);
  box-shadow: 0 12px 32px rgba(0,0,0,0.7);
  z-index: 10;
}

.card-slot.picked .card-img-wrap {
  box-shadow: 0 0 0 3px #e94560, 0 0 16px rgba(233,69,96,0.4);
}

.card-slot.picked::after {
  content: "PICKED";
  position: absolute;
  top: 8px;
  right: 8px;
  background: #e94560;
  color: #fff;
  font-size: 0.7rem;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 4px;
  z-index: 1;
}

.card-img-wrap {
  height: calc(100% - 20px);
  aspect-ratio: 488 / 680;
  border-radius: 12px;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 0.5s;
}

.card-slot.face-down .card-img-wrap {
  transform: rotateY(180deg);
}

.card-front, .card-back {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  border-radius: 12px;
  overflow: hidden;
}

.card-back {
  transform: rotateY(180deg);
}

.card-back img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.card-slot img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.card-info {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  padding: 2px 0 0;
  align-items: center;
  height: 18px;
}

.badge {
  font-size: 0.65rem;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 3px;
  text-transform: uppercase;
}

.badge.mythic { background: #e94560; color: #fff; }
.badge.rare { background: #d4a017; color: #000; }
.badge.uncommon { background: #8a8a8a; color: #fff; }
.badge.common { background: #444; color: #ccc; }
.badge.foil {
  background: linear-gradient(135deg, #ff6ec7, #7873f5, #4ade80);
  color: #fff;
}
.badge.treatment { background: #0f3460; color: #7ec8e3; }
.badge.price { background: rgba(0,0,0,0.6); color: #4ade80; font-variant-numeric: tabular-nums; }
a.badge.link { background: #333; color: #aaa; text-decoration: none; font-variant-numeric: tabular-nums; }
a.badge.link:hover { color: #fff; background: #555; }
.badge.zoom-badge {
  background: rgba(0,0,0,0.45);
  color: rgba(255,255,255,0.6);
  cursor: pointer;
  font-size: 0.6rem;
  padding: 2px 4px;
}
.badge.zoom-badge:hover { background: rgba(0,0,0,0.7); color: #fff; }

.picks-panel {
  width: 300px;
  background: #16213e;
  border-left: 2px solid #0f3460;
  padding: 16px;
  overflow-y: auto;
}

.picks-panel h2 {
  font-size: 1rem;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.picks-panel h2 span {
  color: #888;
  font-weight: 400;
  font-size: 0.85rem;
}

#clear-picks {
  font-size: 0.75rem;
  padding: 4px 10px;
  background: #333;
  border-color: #555;
}

#clear-picks:hover { background: #e94560; border-color: #e94560; }

.pick-list {
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.pick-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  background: #1a1a2e;
  border-radius: 6px;
  font-size: 0.8rem;
  cursor: pointer;
}

.pick-item:hover { background: #222244; }

.pick-item img {
  width: 40px;
  border-radius: 4px;
}

.pick-item .pick-name {
  flex: 1;
  line-height: 1.2;
}

.pick-item .pick-set {
  color: #888;
  font-size: 0.7rem;
}

.pick-item .remove-pick {
  color: #888;
  font-size: 1rem;
  cursor: pointer;
  padding: 0 4px;
}

.pick-item .remove-pick:hover { color: #e94560; }

.empty-state {
  color: #555;
  font-style: italic;
  font-size: 0.85rem;
  margin-top: 16px;
}

@media (max-width: 768px) {
  .main { flex-direction: column; }
  .picks-panel { width: 100%; border-left: none; border-top: 2px solid #0f3460; }
}
</style>
</head>
<body>

<header>
  <h1>Crack-a-Pack</h1>
  <div class="controls">
    <div class="set-search-wrap">
      <input type="text" class="set-search-input" id="set-input" placeholder="Loading sets..." disabled autocomplete="off">
      <ul class="set-dropdown" id="set-dropdown"></ul>
    </div>
    <div class="product-radios" id="product-radios"></div>
    <button id="open-btn" disabled>Open Pack</button>
    <div class="product-radios"><input type="checkbox" id="open-mode"><label for="open-mode">Open</label></div>
  </div>
  <div id="status">
    <span class="prices-status" id="prices-status" title="Click to update CK prices"></span>
    <span id="status-text"></span>
  </div>
</header>

<div class="main">
  <div class="pack-area">
    <h2 id="pack-header">Select a set and open a pack</h2>
    <div class="pack-grid" id="pack-grid"></div>
  </div>

  <div class="picks-panel">
    <h2>Picks <span id="pick-count">(0)</span></h2>
    <button id="clear-picks">Clear All</button>
    <ul class="pick-list" id="pick-list"></ul>
  </div>
</div>

<script>
const setInput = document.getElementById('set-input');
const setDropdown = document.getElementById('set-dropdown');
const productRadios = document.getElementById('product-radios');
const openBtn = document.getElementById('open-btn');
const statusText = document.getElementById('status-text');
const pricesStatus = document.getElementById('prices-status');
const packGrid = document.getElementById('pack-grid');
const packHeader = document.getElementById('pack-header');
const pickList = document.getElementById('pick-list');
const pickCount = document.getElementById('pick-count');
const clearBtn = document.getElementById('clear-picks');
const openModeCheckbox = document.getElementById('open-mode');

let allSets = [];
let selectedSetCode = '';
let activeDropdownIndex = -1;
let picks = JSON.parse(localStorage.getItem('crackPackPicks') || '[]');
let currentPack = [];

// --- Prices status ---

function formatTimeAgo(isoStr) {
  if (!isoStr) return 'not loaded';
  const diff = Date.now() - new Date(isoStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hours = Math.floor(mins / 60);
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours / 24);
  return `${days}d ago`;
}

async function loadPricesStatus() {
  try {
    const res = await fetch('/api/prices-status');
    const data = await res.json();
    if (data.available) {
      pricesStatus.textContent = `CK: ${formatTimeAgo(data.last_modified)}`;
    } else {
      pricesStatus.textContent = 'CK: not loaded';
    }
  } catch {
    pricesStatus.textContent = 'CK: unavailable';
  }
}

pricesStatus.addEventListener('click', async () => {
  pricesStatus.classList.add('loading');
  pricesStatus.textContent = 'CK: downloading...';
  try {
    const res = await fetch('/api/fetch-prices', { method: 'POST' });
    const data = await res.json();
    if (data.error) {
      pricesStatus.textContent = 'CK: error';
    } else {
      pricesStatus.textContent = `CK: ${formatTimeAgo(data.last_modified)}`;
    }
  } catch {
    pricesStatus.textContent = 'CK: error';
  }
  pricesStatus.classList.remove('loading');
});

// --- Picks ---

function savePicks() {
  localStorage.setItem('crackPackPicks', JSON.stringify(picks));
  renderPicks();
}

function renderPicks() {
  pickCount.textContent = `(${picks.length})`;
  pickList.innerHTML = '';
  if (picks.length === 0) {
    pickList.innerHTML = '<li class="empty-state">Click cards to pick them</li>';
    return;
  }
  picks.forEach((card, i) => {
    const li = document.createElement('li');
    li.className = 'pick-item';
    const price = card.tcg_price || card.price;
    li.innerHTML = `
      <img src="${card.image_uri}" alt="" loading="lazy">
      <div>
        <div class="pick-name">${card.name}</div>
        <div class="pick-set">${card.set_code} #${card.collector_number}${price ? ` — $${parseFloat(price).toFixed(2)}` : ''}</div>
      </div>
      <span class="remove-pick" data-index="${i}">&times;</span>
    `;
    li.querySelector('.remove-pick').addEventListener('click', (e) => {
      e.stopPropagation();
      picks.splice(i, 1);
      savePicks();
      syncPickState();
    });
    pickList.appendChild(li);
  });
}

function syncPickState() {
  document.querySelectorAll('.card-slot').forEach(slot => {
    const id = slot.dataset.scryfallId;
    const idx = parseInt(slot.dataset.index);
    const isPicked = picks.some(p => p.scryfall_id === id && p._packIndex === idx);
    slot.classList.toggle('picked', isPicked);
  });
}

// --- Badges ---

function buildBadges(card) {
  let html = '';
  // Zoom badge first
  html += '<span class="badge zoom-badge">&#128269;</span>';
  // Links with prices
  if (card.scryfall_id) {
    const sfPrice = card.tcg_price ? ` $${parseFloat(card.tcg_price).toFixed(2)}` : '';
    html += `<a class="badge link" href="https://scryfall.com/card/${card.set_code.toLowerCase()}/${card.collector_number}" target="_blank" rel="noopener" onclick="event.stopPropagation()">SF${sfPrice}</a>`;
    if (card.ck_url) {
      const ckPrice = card.ck_price ? ` $${parseFloat(card.ck_price).toFixed(2)}` : '';
      html += `<a class="badge link" href="${card.ck_url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">CK${ckPrice}</a>`;
    }
  }
  if (card.rarity && card.rarity !== 'common') {
    const abbrev = {mythic: 'M', rare: 'R', uncommon: 'U'};
    html += `<span class="badge ${card.rarity}">${abbrev[card.rarity] || card.rarity[0].toUpperCase()}</span>`;
  }
  if (card.foil) html += '<span class="badge foil">F</span>';
  if (card.border_color === 'borderless') html += '<span class="badge treatment">BL</span>';
  if (card.frame_effects && card.frame_effects.includes('showcase'))
    html += '<span class="badge treatment">SC</span>';
  if (card.frame_effects && card.frame_effects.includes('extendedart'))
    html += '<span class="badge treatment">EA</span>';
  if (card.is_full_art) html += '<span class="badge treatment">FA</span>';
  return html;
}

// --- Searchable set selector ---

function filterSets(query) {
  const q = query.toLowerCase();
  if (!q) return allSets;
  return allSets.filter(s =>
    s.name.toLowerCase().includes(q) || s.code.toLowerCase().includes(q)
  );
}

function renderDropdown(sets) {
  setDropdown.innerHTML = '';
  activeDropdownIndex = -1;
  sets.forEach((s, i) => {
    const li = document.createElement('li');
    li.textContent = `${s.name} (${s.code})`;
    li.dataset.code = s.code;
    li.addEventListener('mousedown', (e) => {
      e.preventDefault(); // prevent blur before click fires
      selectSet(s);
    });
    setDropdown.appendChild(li);
  });
}

function showDropdown() {
  const filtered = filterSets(selectedSetCode ? '' : setInput.value);
  renderDropdown(filtered);
  setDropdown.classList.add('open');
}

function hideDropdown() {
  setDropdown.classList.remove('open');
  activeDropdownIndex = -1;
}

function selectSet(s) {
  selectedSetCode = s.code;
  setInput.value = `${s.name} (${s.code})`;
  hideDropdown();
  loadProducts(s.code);
}

setInput.addEventListener('focus', () => {
  if (selectedSetCode) {
    selectedSetCode = '';
    setInput.value = '';
  }
  showDropdown();
});

setInput.addEventListener('input', () => {
  selectedSetCode = '';
  const filtered = filterSets(setInput.value);
  renderDropdown(filtered);
  setDropdown.classList.add('open');
});

setInput.addEventListener('blur', () => {
  hideDropdown();
});

setInput.addEventListener('keydown', (e) => {
  const items = setDropdown.querySelectorAll('li');
  if (!items.length) return;

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    activeDropdownIndex = Math.min(activeDropdownIndex + 1, items.length - 1);
    items.forEach((li, i) => li.classList.toggle('active', i === activeDropdownIndex));
    items[activeDropdownIndex].scrollIntoView({block: 'nearest'});
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    activeDropdownIndex = Math.max(activeDropdownIndex - 1, 0);
    items.forEach((li, i) => li.classList.toggle('active', i === activeDropdownIndex));
    items[activeDropdownIndex].scrollIntoView({block: 'nearest'});
  } else if (e.key === 'Enter') {
    e.preventDefault();
    if (activeDropdownIndex >= 0 && activeDropdownIndex < items.length) {
      const code = items[activeDropdownIndex].dataset.code;
      const s = allSets.find(s => s.code === code);
      if (s) selectSet(s);
    }
  } else if (e.key === 'Escape') {
    hideDropdown();
    setInput.blur();
  }
});

// --- Set & product loading ---

async function loadSets() {
  statusText.textContent = 'Loading sets...';
  const res = await fetch('/api/sets');
  const sets = await res.json();
  allSets = sets;
  setInput.disabled = false;
  setInput.placeholder = 'Search sets...';
  statusText.textContent = `${sets.length} sets loaded`;
}

async function loadProducts(setCode) {
  productRadios.innerHTML = '<span style="color:#888;font-size:0.85rem">Loading...</span>';
  openBtn.disabled = true;
  const res = await fetch(`/api/products?set=${encodeURIComponent(setCode)}`);
  const products = await res.json();
  productRadios.innerHTML = '';
  products.forEach((p, i) => {
    const id = `product-${p}`;
    const radio = document.createElement('input');
    radio.type = 'radio';
    radio.name = 'product';
    radio.value = p;
    radio.id = id;
    if (i === 0) radio.checked = true;
    radio.addEventListener('change', () => { openBtn.disabled = false; });
    const label = document.createElement('label');
    label.htmlFor = id;
    label.textContent = p;
    productRadios.appendChild(radio);
    productRadios.appendChild(label);
  });
  if (products.length > 0) openBtn.disabled = false;
}

function getSelectedProduct() {
  const checked = productRadios.querySelector('input[name="product"]:checked');
  return checked ? checked.value : '';
}

function setSelectedProduct(value) {
  const radio = productRadios.querySelector(`input[name="product"][value="${value}"]`);
  if (radio) radio.checked = true;
}

// --- URL hash ---

function updateHash(setCode, product, seed) {
  location.hash = `set=${encodeURIComponent(setCode)}&product=${encodeURIComponent(product)}&seed=${seed}`;
}

function parseHash() {
  const hash = location.hash.replace(/^#/, '');
  const params = new URLSearchParams(hash);
  const set = params.get('set');
  const product = params.get('product');
  const seed = params.get('seed');
  if (set && product && seed) {
    return { set, product, seed: parseInt(seed) };
  }
  return null;
}

// --- Zoom ---

function unzoomAll() {
  document.querySelectorAll('.card-slot.zoomed').forEach(el => el.classList.remove('zoomed'));
}

// --- Pack generation ---

async function openPack(seed) {
  const setCode = selectedSetCode;
  const product = getSelectedProduct();
  if (!setCode || !product) return;

  openBtn.disabled = true;
  statusText.textContent = 'Generating pack...';

  const body = {set_code: setCode, product: product};
  if (seed != null) body.seed = seed;

  const res = await fetch('/api/generate', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body),
  });
  const result = await res.json();

  updateHash(setCode, product, result.seed);

  currentPack = result.cards || [];
  const pct = ((result.variant_weight / result.total_weight) * 100).toFixed(1);
  const packTotal = currentPack.reduce((sum, c) => sum + (parseFloat(c.tcg_price) || 0), 0);
  const totalStr = packTotal > 0 ? ` — $${packTotal.toFixed(2)}` : '';
  packHeader.textContent = `${setCode} ${product} — ${currentPack.length} cards (variant ${result.variant_index}, ${pct}%)${totalStr}`;

  packGrid.innerHTML = '';

  const isOpenMode = openModeCheckbox.checked;

  // Calculate rows needed so cards fit vertically
  const cardCount = currentPack.length;
  const gridWidth = packGrid.clientWidth;
  const availHeight = window.innerHeight - 150;
  let rows = 1;
  for (rows = 1; rows <= cardCount; rows++) {
    const cardH = (availHeight - (rows - 1) * 12) / rows;
    const cardW = cardH * (488 / 680);
    const cols = Math.floor((gridWidth + 12) / (cardW + 12));
    if (cols * rows >= cardCount) break;
  }
  packGrid.style.setProperty('--pack-rows', rows);

  currentPack.forEach((card, i) => {
    card._packIndex = i;
    const div = document.createElement('div');
    div.className = 'card-slot' + (isOpenMode ? ' face-down' : '');
    div.dataset.scryfallId = card.scryfall_id;
    div.dataset.index = i;
    div.innerHTML = `
      <div class="card-img-wrap">
        <div class="card-front"><img src="${card.image_uri}" alt="${card.name}" loading="lazy"></div>
        <div class="card-back"><img src="/static/card_back.jpeg" alt=""></div>
      </div>
      <div class="card-info">${buildBadges(card)}</div>
    `;
    // Zoom badge click
    div.querySelector('.zoom-badge').addEventListener('click', (e) => {
      e.stopPropagation();
      if (div.classList.contains('face-down')) return;
      div.classList.add('zoomed');
      setTimeout(() => {
        document.addEventListener('click', function handler() {
          unzoomAll();
          document.removeEventListener('click', handler);
        }, { once: true });
      }, 0);
    });
    // Card click: flip or pick
    div.addEventListener('click', () => {
      if (div.classList.contains('zoomed')) return;
      if (div.classList.contains('face-down')) {
        div.classList.remove('face-down');
        return;
      }
      togglePick(card, i);
    });
    packGrid.appendChild(div);
  });

  syncPickState();
  openBtn.disabled = false;
  statusText.textContent = '';
}

function togglePick(card, packIndex) {
  const existing = picks.findIndex(p => p.scryfall_id === card.scryfall_id && p._packIndex === packIndex);
  if (existing >= 0) {
    picks.splice(existing, 1);
  } else {
    picks.push({...card, _packIndex: packIndex});
  }
  savePicks();
  syncPickState();
}

openBtn.addEventListener('click', () => openPack());

clearBtn.addEventListener('click', () => {
  picks = [];
  savePicks();
  syncPickState();
});

// --- Init ---

renderPicks();
loadPricesStatus();

loadSets().then(async () => {
  const hashParams = parseHash();
  if (hashParams) {
    const s = allSets.find(s => s.code.toLowerCase() === hashParams.set.toLowerCase());
    if (s) {
      selectSet(s);
      await loadProducts(s.code);
      setSelectedProduct(hashParams.product);
      openPack(hashParams.seed);
    }
  }
});
</script>

</body>
</html>
