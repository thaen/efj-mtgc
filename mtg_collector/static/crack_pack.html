<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Crack-a-Pack</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: #1a1a2e;
  color: #e0e0e0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

header {
  background: #16213e;
  padding: 16px 24px;
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
  flex-shrink: 0;
  border-bottom: 2px solid #0f3460;
}

header h1 {
  font-size: 1.3rem;
  color: #e94560;
  margin-right: 16px;
  white-space: nowrap;
}

.controls {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

select, button, .set-search-input {
  padding: 8px 14px;
  border: 1px solid #0f3460;
  border-radius: 6px;
  background: #1a1a2e;
  color: #e0e0e0;
  font-size: 0.9rem;
  cursor: pointer;
}

select:focus, button:focus, .set-search-input:focus { outline: 2px solid #e94560; }

.set-search-wrap {
  position: relative;
}

.set-search-input {
  width: 260px;
  cursor: text;
}

.set-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  max-height: 300px;
  overflow-y: auto;
  background: #1a1a2e;
  border: 1px solid #0f3460;
  border-top: none;
  border-radius: 0 0 6px 6px;
  z-index: 100;
  list-style: none;
}

.set-dropdown.open { display: block; }

.set-dropdown li {
  padding: 6px 14px;
  font-size: 0.9rem;
  cursor: pointer;
}

.set-dropdown li:hover, .set-dropdown li.active {
  background: #0f3460;
}

.product-radios {
  display: flex;
  gap: 6px;
  align-items: center;
  flex-wrap: wrap;
}

.product-radios label {
  display: inline-block;
  padding: 6px 14px;
  border: 1px solid #0f3460;
  border-radius: 20px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
  user-select: none;
}

.product-radios input[type="radio"] { display: none; }
.product-radios input[type="checkbox"] { display: none; }

.product-radios input[type="radio"]:checked + label,
.product-radios input[type="checkbox"]:checked + label {
  background: #e94560;
  border-color: #e94560;
  color: #fff;
}

button {
  background: #e94560;
  border-color: #e94560;
  color: #fff;
  font-weight: 600;
}

button:hover { background: #c73651; }
button:disabled { opacity: 0.4; cursor: not-allowed; }

#status {
  font-size: 0.85rem;
  color: #888;
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 12px;
}

.prices-status {
  font-size: 0.75rem;
  color: #666;
  cursor: pointer;
  user-select: none;
}

.prices-status:hover { color: #aaa; }

.prices-status.loading { color: #e94560; }

.main {
  display: flex;
  gap: 0;
  flex: 1;
  overflow: hidden;
}

.pack-area {
  flex: 1;
  padding: 24px;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}

.pack-area h2 {
  font-size: 1rem;
  color: #888;
  margin-bottom: 16px;
}

.pack-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-content: flex-start;
  flex: 1;
}

.card-slot {
  position: relative;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s;
  height: var(--card-height, 280px);
  perspective: 800px;
}

.size-slider-wrap {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.8rem;
  color: #888;
}

.size-slider-wrap input[type="range"] {
  width: 100px;
  accent-color: #e94560;
}

#zoom-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.75);
  z-index: 100;
  justify-content: center;
  align-items: center;
  cursor: pointer;
}

#zoom-overlay.active { display: flex; }

#zoom-overlay img {
  max-height: 85vh;
  max-width: 90vw;
  border-radius: 16px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.8);
}

.card-slot.picked .card-img-wrap {
  box-shadow: 0 0 0 3px #e94560, 0 0 16px rgba(233,69,96,0.4);
}

.card-slot.picked::after {
  content: "PICKED";
  position: absolute;
  top: 8px;
  right: 8px;
  background: #e94560;
  color: #fff;
  font-size: 0.7rem;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 4px;
  z-index: 1;
}

.card-img-wrap {
  height: calc(100% - 20px);
  aspect-ratio: 488 / 680;
  border-radius: 12px;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 0.5s;
  --rarity-color: #111;
  --set-color: #111;
  background: linear-gradient(to bottom, var(--rarity-color), var(--set-color));
}

.card-slot.face-down .card-img-wrap {
  transform: rotateY(180deg);
  background: #111;
}

.card-slot.face-down .card-front.foil::before,
.card-slot.face-down .card-front.foil::after {
  display: none;
}

.card-front, .card-back {
  position: absolute;
  top: 2px; left: 2px;
  width: calc(100% - 4px);
  height: calc(100% - 4px);
  backface-visibility: hidden;
  border-radius: 10px;
  overflow: hidden;
}

.card-back {
  transform: rotateY(180deg);
}

.card-back img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* Foil: rainbow wash */
.card-front.foil::before {
  content: "";
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: repeating-linear-gradient(
    135deg,
    rgba(255,0,0,0.08),
    rgba(255,165,0,0.08) 5%,
    rgba(255,255,0,0.08) 10%,
    rgba(0,200,0,0.08) 15%,
    rgba(0,140,255,0.08) 20%,
    rgba(130,0,255,0.08) 25%,
    rgba(255,0,200,0.08) 30%,
    rgba(255,0,0,0.08) 33.33%
  );
  mix-blend-mode: color;
  pointer-events: none;
  z-index: 1;
}

/* Foil: animated light streak */
.card-front.foil::after {
  content: "";
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background:
    linear-gradient(135deg, transparent 46%, rgba(255,255,255,0.12) 49%, rgba(255,255,255,0.12) 51%, transparent 54%)
    100% 100% / 240% 240%;
  pointer-events: none;
  z-index: 2;
  animation: foil-streak 3s ease-in-out infinite;
}

@keyframes foil-streak {
  0% { background-position: 100% 100%; }
  15%, 100% { background-position: 0 0; }
}

.card-slot img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  image-rendering: high-quality;
}

.card-info {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  padding: 2px 0 0;
  align-items: center;
  height: 18px;
}

.badge {
  font-size: 0.65rem;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 3px;
  text-transform: uppercase;
}

.badge.treatment { background: linear-gradient(135deg, #0f2a3e, #0f3460); border: 1px solid #1a5276; color: #7ec8e3; }
.badge.price { background: rgba(0,0,0,0.6); border: 1px solid rgba(74,222,128,0.3); color: #4ade80; font-variant-numeric: tabular-nums; }
a.badge.link { background: #333; border: 1px solid #555; color: #aaa; text-decoration: none; font-variant-numeric: tabular-nums; }
a.badge.link:hover { color: #fff; background: #555; border-color: #777; }
.badge.zoom-badge {
  background: rgba(0,0,0,0.45);
  color: rgba(255,255,255,0.6);
  cursor: pointer;
  font-size: 0.6rem;
  padding: 2px 4px;
}
.badge.zoom-badge:hover { background: rgba(0,0,0,0.7); color: #fff; }

.picks-panel {
  width: 300px;
  background: #16213e;
  border-left: 2px solid #0f3460;
  padding: 16px;
  overflow-y: auto;
}

.picks-panel h2 {
  font-size: 1rem;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.picks-panel h2 span {
  color: #888;
  font-weight: 400;
  font-size: 0.85rem;
}

#clear-picks {
  font-size: 0.75rem;
  padding: 4px 10px;
  background: #333;
  border-color: #555;
}

#clear-picks:hover { background: #e94560; border-color: #e94560; }

.pick-list {
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.pick-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  padding-left: 12px;
  background: #1a1a2e;
  border-radius: 6px;
  font-size: 0.8rem;
  cursor: pointer;
  position: relative;
  --rarity-color: #111;
  --set-color: #111;
}

.pick-item::before {
  content: "";
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  border-radius: 6px 0 0 6px;
  background: linear-gradient(to bottom, var(--rarity-color), var(--set-color));
}

.pick-item:hover { background: #222244; }

.pick-item img {
  width: 40px;
  border-radius: 4px;
}

.pick-item .pick-name {
  flex: 1;
  line-height: 1.2;
}

.pick-item .pick-set {
  color: #888;
  font-size: 0.7rem;
}

.pick-item .pick-badges {
  display: flex;
  gap: 3px;
  flex-wrap: wrap;
  margin-top: 2px;
}

.pick-item .remove-pick {
  color: #888;
  font-size: 1rem;
  cursor: pointer;
  padding: 0 4px;
}

.pick-item .remove-pick:hover { color: #e94560; }

.empty-state {
  color: #555;
  font-style: italic;
  font-size: 0.85rem;
  margin-top: 16px;
}

@media (max-width: 768px) {
  .main { flex-direction: column; }
  .picks-panel { width: 100%; border-left: none; border-top: 2px solid #0f3460; }
}
</style>
</head>
<body>

<header>
  <h1>Crack-a-Pack</h1>
  <div class="controls">
    <div class="set-search-wrap">
      <input type="text" class="set-search-input" id="set-input" placeholder="Loading sets..." disabled autocomplete="off">
      <ul class="set-dropdown" id="set-dropdown"></ul>
    </div>
    <div class="product-radios" id="product-radios"></div>
    <button id="open-btn" disabled>Open Pack</button>
    <div class="product-radios"><input type="checkbox" id="open-mode" checked><label for="open-mode">Surprise</label></div>
    <button id="reveal-all-btn" disabled>Reveal All</button>
    <button id="sheets-btn" disabled style="background:#333;border-color:#555">Explore Sheets</button>
    <div class="size-slider-wrap"><span>Size</span><input type="range" id="card-size-slider" min="120" max="500" value="280"></div>
  </div>
  <div id="status">
    <span class="prices-status" id="prices-status" title="Click to update CK prices"></span>
    <span id="status-text"></span>
  </div>
</header>

<div id="zoom-overlay"><img id="zoom-img" src="" alt=""></div>

<div class="main">
  <div class="pack-area">
    <h2 id="pack-header">Select a set and open a pack</h2>
    <div class="pack-grid" id="pack-grid"></div>
  </div>

  <div class="picks-panel">
    <h2>Picks <span id="pick-count">(0)</span></h2>
    <button id="clear-picks">Clear All</button>
    <ul class="pick-list" id="pick-list"></ul>
  </div>
</div>

<script>
const setInput = document.getElementById('set-input');
const setDropdown = document.getElementById('set-dropdown');
const productRadios = document.getElementById('product-radios');
const openBtn = document.getElementById('open-btn');
const statusText = document.getElementById('status-text');
const pricesStatus = document.getElementById('prices-status');
const packGrid = document.getElementById('pack-grid');
const packHeader = document.getElementById('pack-header');
const pickList = document.getElementById('pick-list');
const pickCount = document.getElementById('pick-count');
const clearBtn = document.getElementById('clear-picks');
const openModeCheckbox = document.getElementById('open-mode');
const revealAllBtn = document.getElementById('reveal-all-btn');
const sheetsBtn = document.getElementById('sheets-btn');
const zoomOverlay = document.getElementById('zoom-overlay');
const zoomImg = document.getElementById('zoom-img');

let allSets = [];
let selectedSetCode = '';
let activeDropdownIndex = -1;
let picks = JSON.parse(localStorage.getItem('crackPackPicks') || '[]');
let currentPack = [];
let currentPackSeed = null;
let currentPackSetCode = null;
let _settings = {};

const cardSizeSlider = document.getElementById('card-size-slider');

function applyCardSize(h) {
  packGrid.style.setProperty('--card-height', h + 'px');
  localStorage.setItem('crackPackCardSize', h);
}

// Restore saved size
const savedSize = localStorage.getItem('crackPackCardSize');
if (savedSize) {
  cardSizeSlider.value = savedSize;
  applyCardSize(savedSize);
}

cardSizeSlider.addEventListener('input', () => applyCardSize(cardSizeSlider.value));

// --- Prices status ---

function formatTimeAgo(isoStr) {
  if (!isoStr) return 'not loaded';
  const diff = Date.now() - new Date(isoStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hours = Math.floor(mins / 60);
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours / 24);
  return `${days}d ago`;
}

async function loadPricesStatus() {
  try {
    const res = await fetch('/api/prices-status');
    const data = await res.json();
    if (data.available) {
      pricesStatus.textContent = `CK: ${formatTimeAgo(data.last_modified)}`;
    } else {
      pricesStatus.textContent = 'CK: not loaded';
    }
  } catch {
    pricesStatus.textContent = 'CK: unavailable';
  }
}

pricesStatus.addEventListener('click', async () => {
  pricesStatus.classList.add('loading');
  pricesStatus.textContent = 'CK: downloading...';
  try {
    const res = await fetch('/api/fetch-prices', { method: 'POST' });
    const data = await res.json();
    if (data.error) {
      pricesStatus.textContent = 'CK: error';
    } else {
      pricesStatus.textContent = `CK: ${formatTimeAgo(data.last_modified)}`;
    }
  } catch {
    pricesStatus.textContent = 'CK: error';
  }
  pricesStatus.classList.remove('loading');
});

// --- Border colors ---

const RARITY_COLORS = {common: '#111', uncommon: '#6a6a6a', rare: '#c9a816', mythic: '#d4422a'};

function getRarityColor(rarity) { return RARITY_COLORS[rarity] || '#111'; }
function getSetColor(cardSetCode, packSetCode) {
  if (!packSetCode) return '#111';
  return cardSetCode.toUpperCase() !== packSetCode.toUpperCase() ? '#5c2d91' : '#111';
}

// --- Picks ---

function savePicks() {
  localStorage.setItem('crackPackPicks', JSON.stringify(picks));
  renderPicks();
}

function renderPicks() {
  pickCount.textContent = `(${picks.length})`;
  pickList.innerHTML = '';
  if (picks.length === 0) {
    pickList.innerHTML = '<li class="empty-state">Click cards to pick them</li>';
    return;
  }
  picks.forEach((card, i) => {
    const li = document.createElement('li');
    li.className = 'pick-item';
    li.style.setProperty('--rarity-color', getRarityColor(card.rarity));
    li.style.setProperty('--set-color', getSetColor(card.set_code, card._packSetCode));
    li.innerHTML = `
      <img src="${card.image_uri}" alt="" loading="lazy">
      <div>
        <div class="pick-name">${card.name}</div>
        <div class="pick-set">${card.set_code} #${card.collector_number}</div>
        <div class="pick-badges">${buildCardBadges(card, card._packSetCode)}</div>
      </div>
      <span class="remove-pick" data-index="${i}">&times;</span>
    `;
    li.querySelector('.remove-pick').addEventListener('click', (e) => {
      e.stopPropagation();
      picks.splice(i, 1);
      savePicks();
      syncPickState();
    });
    pickList.appendChild(li);
  });
}

function syncPickState() {
  document.querySelectorAll('.card-slot').forEach(slot => {
    const id = slot.dataset.scryfallId;
    const idx = parseInt(slot.dataset.index);
    const isPicked = picks.some(p => p.scryfall_id === id && p._packIndex === idx);
    slot.classList.toggle('picked', isPicked);
  });
}

// --- Badges ---

function buildCardBadges(card, packSetCode) {
  let html = '';
  const sources = (_settings.price_sources || 'tcg,ck').split(',');
  if (sources.includes('tcg') && card.scryfall_id) {
    const sfPrice = card.tcg_price ? ` $${parseFloat(card.tcg_price).toFixed(2)}` : '';
    html += `<a class="badge link" href="https://scryfall.com/card/${card.set_code.toLowerCase()}/${card.collector_number}" target="_blank" rel="noopener" onclick="event.stopPropagation()">SF${sfPrice}</a>`;
  }
  if (sources.includes('ck') && card.ck_url) {
    const ckPrice = card.ck_price ? ` $${parseFloat(card.ck_price).toFixed(2)}` : '';
    html += `<a class="badge link" href="${card.ck_url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">CK${ckPrice}</a>`;
  }
  if (card.border_color === 'borderless') html += '<span class="badge treatment">BL</span>';
  if (card.frame_effects && card.frame_effects.includes('showcase'))
    html += '<span class="badge treatment">SC</span>';
  if (card.frame_effects && card.frame_effects.includes('extendedart'))
    html += '<span class="badge treatment">EA</span>';
  if (card.is_full_art) html += '<span class="badge treatment">FA</span>';
  return html;
}

function buildBadges(card, packSetCode) {
  return '<span class="badge zoom-badge">&#128269;</span>' + buildCardBadges(card, packSetCode);
}

// --- Searchable set selector ---

function filterSets(query) {
  const q = query.toLowerCase();
  if (!q) return allSets;
  return allSets.filter(s =>
    s.name.toLowerCase().includes(q) || s.code.toLowerCase().includes(q)
  );
}

function renderDropdown(sets) {
  setDropdown.innerHTML = '';
  activeDropdownIndex = -1;
  sets.forEach((s, i) => {
    const li = document.createElement('li');
    li.textContent = `${s.name} (${s.code})`;
    li.dataset.code = s.code;
    li.addEventListener('mousedown', (e) => {
      e.preventDefault(); // prevent blur before click fires
      selectSet(s);
    });
    setDropdown.appendChild(li);
  });
}

function showDropdown() {
  const filtered = filterSets(selectedSetCode ? '' : setInput.value);
  renderDropdown(filtered);
  setDropdown.classList.add('open');
}

function hideDropdown() {
  setDropdown.classList.remove('open');
  activeDropdownIndex = -1;
}

function selectSet(s) {
  selectedSetCode = s.code;
  setInput.value = `${s.name} (${s.code})`;
  hideDropdown();
  loadProducts(s.code);
}

setInput.addEventListener('focus', () => {
  if (selectedSetCode) {
    selectedSetCode = '';
    setInput.value = '';
  }
  showDropdown();
});

setInput.addEventListener('input', () => {
  selectedSetCode = '';
  const filtered = filterSets(setInput.value);
  renderDropdown(filtered);
  setDropdown.classList.add('open');
});

setInput.addEventListener('blur', () => {
  hideDropdown();
});

setInput.addEventListener('keydown', (e) => {
  const items = setDropdown.querySelectorAll('li');
  if (!items.length) return;

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    activeDropdownIndex = Math.min(activeDropdownIndex + 1, items.length - 1);
    items.forEach((li, i) => li.classList.toggle('active', i === activeDropdownIndex));
    items[activeDropdownIndex].scrollIntoView({block: 'nearest'});
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    activeDropdownIndex = Math.max(activeDropdownIndex - 1, 0);
    items.forEach((li, i) => li.classList.toggle('active', i === activeDropdownIndex));
    items[activeDropdownIndex].scrollIntoView({block: 'nearest'});
  } else if (e.key === 'Enter') {
    e.preventDefault();
    if (activeDropdownIndex >= 0 && activeDropdownIndex < items.length) {
      const code = items[activeDropdownIndex].dataset.code;
      const s = allSets.find(s => s.code === code);
      if (s) selectSet(s);
    }
  } else if (e.key === 'Escape') {
    hideDropdown();
    setInput.blur();
  }
});

// --- Set & product loading ---

async function loadSets() {
  statusText.textContent = 'Loading sets...';
  const res = await fetch('/api/sets');
  const sets = await res.json();
  allSets = sets;
  setInput.disabled = false;
  setInput.placeholder = 'Search sets...';
  statusText.textContent = `${sets.length} sets loaded`;
}

async function loadProducts(setCode) {
  productRadios.innerHTML = '<span style="color:#888;font-size:0.85rem">Loading...</span>';
  openBtn.disabled = true;
  const res = await fetch(`/api/products?set=${encodeURIComponent(setCode)}`);
  const products = await res.json();
  productRadios.innerHTML = '';
  products.forEach((p, i) => {
    const id = `product-${p}`;
    const radio = document.createElement('input');
    radio.type = 'radio';
    radio.name = 'product';
    radio.value = p;
    radio.id = id;
    if (i === 0) radio.checked = true;
    radio.addEventListener('change', () => { openBtn.disabled = false; });
    const label = document.createElement('label');
    label.htmlFor = id;
    label.textContent = p;
    productRadios.appendChild(radio);
    productRadios.appendChild(label);
  });
  if (products.length > 0) {
    openBtn.disabled = false;
    sheetsBtn.disabled = false;
  }
}

function getSelectedProduct() {
  const checked = productRadios.querySelector('input[name="product"]:checked');
  return checked ? checked.value : '';
}

function setSelectedProduct(value) {
  const radio = productRadios.querySelector(`input[name="product"][value="${value}"]`);
  if (radio) radio.checked = true;
}

// --- URL hash ---

function updateHash() {
  if (!selectedSetCode || !currentPack.length) return;
  const product = getSelectedProduct();
  const seed = currentPackSeed;
  const surprise = openModeCheckbox.checked ? '1' : '0';
  // Collect indices of face-up cards (not face-down)
  const revealed = [];
  document.querySelectorAll('.card-slot').forEach((slot, i) => {
    if (!slot.classList.contains('face-down')) revealed.push(i);
  });
  const revealedStr = revealed.join(',');
  location.hash = `set=${encodeURIComponent(selectedSetCode)}&product=${encodeURIComponent(product)}&seed=${seed}&surprise=${surprise}&revealed=${revealedStr}`;
}

function parseHash() {
  const hash = location.hash.replace(/^#/, '');
  const params = new URLSearchParams(hash);
  const set = params.get('set');
  const product = params.get('product');
  const seed = params.get('seed');
  if (set && product && seed) {
    const surprise = params.get('surprise');
    const revealed = params.get('revealed');
    return {
      set, product, seed: parseInt(seed),
      surprise: surprise !== '0',
      revealed: revealed ? revealed.split(',').map(Number) : null,
    };
  }
  return null;
}

// --- Zoom ---

function showZoom(imgSrc) {
  zoomImg.src = imgSrc;
  zoomOverlay.classList.add('active');
}

zoomOverlay.addEventListener('click', () => {
  zoomOverlay.classList.remove('active');
});

function syncRevealBtn() {
  revealAllBtn.disabled = !document.querySelector('.card-slot.face-down');
}

revealAllBtn.addEventListener('click', () => {
  document.querySelectorAll('.card-slot.face-down').forEach(el => el.classList.remove('face-down'));
  syncRevealBtn();
  updateHash();
});

sheetsBtn.addEventListener('click', () => {
  const product = getSelectedProduct();
  if (selectedSetCode && product) {
    location.href = `/sheets#set=${encodeURIComponent(selectedSetCode)}&product=${encodeURIComponent(product)}`;
  }
});

// --- Pack generation ---

async function openPack(seed, hashRevealed) {
  const setCode = selectedSetCode;
  const product = getSelectedProduct();
  if (!setCode || !product) return;

  openBtn.disabled = true;
  statusText.textContent = 'Generating pack...';

  const body = {set_code: setCode, product: product};
  if (seed != null) body.seed = seed;

  const res = await fetch('/api/generate', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body),
  });
  const result = await res.json();

  currentPack = result.cards || [];
  currentPackSeed = result.seed;
  currentPackSetCode = result.set_code;

  const pct = ((result.variant_weight / result.total_weight) * 100).toFixed(1);
  const sources = (_settings.price_sources || 'tcg,ck').split(',');
  const packTotal = currentPack.reduce((sum, c) => {
    if (sources.includes('tcg') && c.tcg_price) return sum + parseFloat(c.tcg_price);
    if (sources.includes('ck') && c.ck_price) return sum + parseFloat(c.ck_price);
    return sum;
  }, 0);
  const totalStr = packTotal > 0 ? ` — $${packTotal.toFixed(2)}` : '';
  packHeader.textContent = `${setCode} ${product} — ${currentPack.length} cards (variant ${result.variant_index}, ${pct}%)${totalStr}`;

  packGrid.innerHTML = '';

  const isSurprise = openModeCheckbox.checked;
  const revealedSet = hashRevealed ? new Set(hashRevealed) : null;

  currentPack.forEach((card, i) => {
    card._packIndex = i;
    const div = document.createElement('div');
    // If restoring from hash, use revealed set; otherwise use surprise mode
    const faceDown = revealedSet ? !revealedSet.has(i) : isSurprise;
    div.className = 'card-slot' + (faceDown ? ' face-down' : '');
    div.dataset.scryfallId = card.scryfall_id;
    div.dataset.index = i;

    const rarityColor = getRarityColor(card.rarity);
    const setColor = getSetColor(card.set_code, currentPackSetCode);

    div.innerHTML = `
      <div class="card-img-wrap" style="--rarity-color:${rarityColor};--set-color:${setColor}">
        <div class="card-front${card.foil ? ' foil' : ''}"><img src="${card.image_uri}" alt="${card.name}" loading="lazy"></div>
        <div class="card-back"><img src="/static/card_back.jpeg" alt=""></div>
      </div>
      <div class="card-info">${buildBadges(card, currentPackSetCode)}</div>
    `;
    // Zoom badge click
    div.querySelector('.zoom-badge').addEventListener('click', (e) => {
      e.stopPropagation();
      if (div.classList.contains('face-down')) return;
      showZoom(card.image_uri);
    });
    // Card click: flip or pick
    div.addEventListener('click', () => {
      if (div.classList.contains('face-down')) {
        div.classList.remove('face-down');
        syncRevealBtn();
        updateHash();
        return;
      }
      togglePick(card, i);
    });
    packGrid.appendChild(div);
  });

  syncPickState();
  syncRevealBtn();
  updateHash();
  openBtn.disabled = false;
  statusText.textContent = '';
}

function togglePick(card, packIndex) {
  const existing = picks.findIndex(p => p.scryfall_id === card.scryfall_id && p._packIndex === packIndex);
  if (existing >= 0) {
    picks.splice(existing, 1);
  } else {
    picks.push({...card, _packIndex: packIndex, _packSetCode: currentPackSetCode});
  }
  savePicks();
  syncPickState();
}

openBtn.addEventListener('click', () => openPack());

clearBtn.addEventListener('click', () => {
  picks = [];
  savePicks();
  syncPickState();
});

// --- Init ---

renderPicks();
loadPricesStatus();

fetch('/api/settings').then(r => r.json()).then(s => { _settings = s; });

loadSets().then(async () => {
  const hashParams = parseHash();
  if (hashParams) {
    const s = allSets.find(s => s.code.toLowerCase() === hashParams.set.toLowerCase());
    if (s) {
      openModeCheckbox.checked = hashParams.surprise;
      selectSet(s);
      await loadProducts(s.code);
      setSelectedProduct(hashParams.product);
      openPack(hashParams.seed, hashParams.revealed);
    }
  }
});
</script>

</body>
</html>
