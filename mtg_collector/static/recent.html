<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Recent Images - Card Ingest</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/keyrune@latest/css/keyrune.min.css">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: #1a1a2e;
  color: #e0e0e0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  min-height: 100vh;
}
header {
  background: #16213e;
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  border-bottom: 2px solid #0f3460;
}
header h1 { font-size: 1.1rem; color: #e94560; }
header a { color: #888; text-decoration: none; font-size: 0.8rem; }
header a:hover { color: #e94560; }

.controls {
  margin: 12px;
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}
.controls label { font-size: 0.8rem; color: #888; }
.pill-row { display: flex; gap: 0; }
.pill-row .pill {
  padding: 5px 12px;
  border: 1px solid #0f3460;
  background: #16213e;
  color: #888;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  user-select: none;
}
.pill-row .pill:first-child { border-radius: 6px 0 0 6px; }
.pill-row .pill:last-child { border-radius: 0 6px 6px 0; }
.pill-row .pill + .pill { border-left: none; }
.pill-row .pill.active { background: #e94560; border-color: #e94560; color: #fff; }
.pill-row .pill:hover:not(.active) { border-color: #e94560; color: #e0e0e0; }

.disambig-link {
  margin-left: auto;
  padding: 6px 16px;
  background: #e94560;
  color: #fff;
  text-decoration: none;
  border-radius: 6px;
  font-weight: 600;
  font-size: 0.85rem;
}
.disambig-link:hover { background: #c73651; }

.summary {
  margin: 0 12px 8px;
  font-size: 0.8rem;
  color: #888;
}

#grid {
  margin: 0 12px 12px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 10px;
}

.img-card {
  display: block;
  color: inherit;
  text-decoration: none;
  background: #16213e;
  border: 3px solid #0f3460;
  border-radius: 8px;
  overflow: hidden;
  position: relative;
  transition: border-color 0.2s;
}
.img-card.processing { border-color: #888; }
.img-card.done { border-color: #4caf50; }
.img-card.needs_disambiguation { border-color: #e94560; }
.img-card.error { border-color: #c62828; }

.img-card img {
  width: 100%;
  aspect-ratio: 4 / 5;
  object-fit: cover;
  display: block;
}
.img-card .info-strip {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 4px 6px;
  min-width: 0;
}
.img-card .info-strip i {
  font-size: 1rem;
  color: #bbb;
  flex-shrink: 0;
}
.img-card .info-strip .names {
  font-size: 0.7rem;
  color: #ccc;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.img-card .badge {
  position: absolute;
  top: 4px;
  right: 4px;
  padding: 2px 6px;
  border-radius: 8px;
  font-size: 0.65rem;
  font-weight: 700;
  color: #fff;
}
.img-card.processing .badge { background: rgba(136,136,136,0.8); }
.img-card.done .badge { background: rgba(76,175,80,0.8); }
.img-card.needs_disambiguation .badge { background: rgba(233,69,96,0.8); }
.img-card.error .badge { background: rgba(198,40,40,0.8); }

.img-card .error-icon {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 2rem;
  color: #c62828;
  text-shadow: 0 0 8px rgba(0,0,0,0.8);
  pointer-events: none;
}

.spinner-icon {
  display: inline-block;
  width: 10px; height: 10px;
  border: 2px solid #555;
  border-top-color: #e94560;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  vertical-align: middle;
  margin-right: 3px;
}
@keyframes spin { to { transform: rotate(360deg); } }

.empty-state {
  text-align: center;
  padding: 60px 24px;
  color: #555;
}
.empty-state h2 { color: #888; margin-bottom: 8px; }

/* Error tooltip */
.img-card .error-tooltip {
  display: none;
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(30,0,0,0.95);
  color: #e94560;
  font-size: 0.65rem;
  padding: 6px;
  max-height: 80px;
  overflow-y: auto;
  word-break: break-word;
}
.img-card.error:hover .error-tooltip { display: block; }
.img-card { cursor: pointer; }
.img-card.done:hover { border-color: #66bb6a; }
.img-card.needs_disambiguation:hover { border-color: #f06080; }

#usage-box {
  margin-left: auto;
  font-size: 0.7rem;
  color: #666;
  text-align: right;
  line-height: 1.6;
  white-space: nowrap;
}
#usage-box .usage-cost {
  color: #e0e0e0;
  font-weight: 600;
  font-size: 0.8rem;
}
</style>
</head>
<body>

<header>
  <h1><a href="/" style="color:inherit;text-decoration:none">Recent Images</a></h1>
  <a href="/">Home</a>
  <a href="/upload">Upload</a>
  <a href="/disambiguate">Disambiguate</a>
  <div id="usage-box"></div>
</header>

<div class="controls">
  <label>Time window:</label>
  <div class="pill-row" id="time-pills">
    <div class="pill" data-hours="0.5">30m</div>
    <div class="pill active" data-hours="2">2h</div>
    <div class="pill" data-hours="4">4h</div>
    <div class="pill" data-hours="12">12h</div>
    <div class="pill" data-hours="24">24h</div>
  </div>
  <a id="disambig-btn" class="disambig-link" href="/disambiguate" style="display:none">Disambiguate</a>
</div>

<div class="summary" id="summary"></div>
<div id="grid"></div>
<div id="empty" class="empty-state" style="display:none">
  <h2>No recent images</h2>
  <p><a href="/upload" style="color:#e94560">Upload some photos</a></p>
</div>

<script>
let currentHours = 2;
const activePolls = new Map(); // image_id (number) → intervalId
let discoveryTimer = null;

document.querySelectorAll('#time-pills .pill').forEach(pill => {
  pill.addEventListener('click', () => {
    document.querySelectorAll('#time-pills .pill').forEach(p => p.classList.remove('active'));
    pill.classList.add('active');
    currentHours = parseFloat(pill.dataset.hours);
    loadRecent();
    loadUsageStats();
  });
});

// ── Rendering helpers ────────────────────────────────────────────────────────

function buildCardBadge(img) {
  if (img.border_status === 'processing') return '<span class="spinner-icon"></span>';
  if (img.border_status === 'done') return `${img.total_cards}`;
  if (img.border_status === 'needs_disambiguation') return `${img.pending_count}/${img.total_cards}`;
  if (img.border_status === 'error') return '!';
  return '';
}

const KEYRUNE_FALLBACKS = {
  tsb: 'tsp', pspm: 'spm', cst: 'csp',
};
function keyruneSetCode(code) {
  const lc = (code || '').toLowerCase();
  return KEYRUNE_FALLBACKS[lc] || lc;
}

function buildInfoStrip(img) {
  const cards = img.cards || [];
  const seen = new Set();
  const icons = [];
  for (const c of cards) {
    if (!c.set_code) continue;
    const lc = c.set_code.toLowerCase();
    if (seen.has(lc)) continue;
    seen.add(lc);
    icons.push(`<i class="ss ss-${keyruneSetCode(lc)}" title="${escapeHtml(c.set_code)}"></i>`);
  }
  const names = cards.map(c => c.name).filter(Boolean);
  if (!icons.length && !names.length) return '';
  const iconsHtml = icons.join('');
  const namesHtml = names.length ? `<span class="names">${escapeHtml(names.join(' · '))}</span>` : '';
  return `<div class="info-strip">${iconsHtml}${namesHtml}</div>`;
}

function createCardEl(img) {
  const card = document.createElement('a');
  card.href = '/correct?image_id=' + img.id;
  card.className = `img-card ${img.border_status}`;
  card.dataset.id = String(img.id);
  const errorIcon = img.border_status === 'error' ? '<div class="error-icon">&times;</div>' : '';
  const errorTooltip = img.border_status === 'error' && img.error_message
    ? `<div class="error-tooltip">${escapeHtml(img.error_message.substring(0, 200))}</div>` : '';
  card.innerHTML = `
    <img src="/api/ingest/image/${img.stored_name}" alt="${escapeHtml(img.filename)}" loading="lazy">
    <div class="badge">${buildCardBadge(img)}</div>
    ${errorIcon}
    ${errorTooltip}
    ${buildInfoStrip(img)}
  `;
  return card;
}

function updateCardEl(card, img) {
  card.className = `img-card ${img.border_status}`;
  card.href = '/correct?image_id=' + img.id;
  card.querySelector('.badge').innerHTML = buildCardBadge(img);

  let errorIcon = card.querySelector('.error-icon');
  if (img.border_status === 'error') {
    if (!errorIcon) {
      errorIcon = document.createElement('div');
      errorIcon.className = 'error-icon';
      errorIcon.innerHTML = '&times;';
      card.appendChild(errorIcon);
    }
  } else if (errorIcon) {
    errorIcon.remove();
  }

  let tooltip = card.querySelector('.error-tooltip');
  if (img.border_status === 'error' && img.error_message) {
    if (!tooltip) {
      tooltip = document.createElement('div');
      tooltip.className = 'error-tooltip';
      card.appendChild(tooltip);
    }
    tooltip.textContent = img.error_message.substring(0, 200);
  } else if (tooltip) {
    tooltip.remove();
  }

  const stripHtml = buildInfoStrip(img);
  const stripEl = card.querySelector('.info-strip');
  if (stripHtml) {
    if (stripEl) stripEl.outerHTML = stripHtml;
    else card.insertAdjacentHTML('beforeend', stripHtml);
  } else if (stripEl) {
    stripEl.remove();
  }
}

function updateSummary(images) {
  const summary = document.getElementById('summary');
  const disambigBtn = document.getElementById('disambig-btn');
  if (images.length === 0) {
    summary.textContent = '';
    disambigBtn.style.display = 'none';
    return;
  }
  const counts = { processing: 0, done: 0, needs_disambiguation: 0, error: 0 };
  let totalPending = 0;
  for (const img of images) {
    counts[img.border_status] = (counts[img.border_status] || 0) + 1;
    totalPending += img.pending_count;
  }
  const parts = [];
  if (counts.processing > 0) parts.push(`${counts.processing} processing`);
  if (counts.done > 0) parts.push(`${counts.done} done`);
  if (counts.needs_disambiguation > 0) parts.push(`${counts.needs_disambiguation} need disambiguation`);
  if (counts.error > 0) parts.push(`${counts.error} error`);
  summary.textContent = `${images.length} image(s): ${parts.join(', ')}`;
  if (totalPending > 0) {
    disambigBtn.style.display = '';
    disambigBtn.textContent = `Disambiguate ${totalPending} card(s)`;
  } else {
    disambigBtn.style.display = 'none';
  }
}

// ── Full render (initial load + time-pill changes) ───────────────────────────

async function loadRecent() {
  const resp = await fetch(`/api/ingest2/recent?hours=${currentHours}`);
  const images = await resp.json();

  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');

  updateSummary(images);

  if (images.length === 0) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    syncPolls([]);
    return;
  }
  empty.style.display = 'none';

  const existingCards = {};
  grid.querySelectorAll('.img-card[data-id]').forEach(el => {
    existingCards[el.dataset.id] = el;
  });

  const newIds = new Set(images.map(img => String(img.id)));
  for (const [id, el] of Object.entries(existingCards)) {
    if (!newIds.has(id)) el.remove();
  }

  let prevEl = null;
  for (const img of images) {
    const id = String(img.id);
    let card = existingCards[id];
    if (card) {
      updateCardEl(card, img);
    } else {
      card = createCardEl(img);
      if (prevEl) prevEl.after(card);
      else grid.prepend(card);
    }
    if (prevEl && card.previousElementSibling !== prevEl) prevEl.after(card);
    prevEl = card;
  }

  syncPolls(images);
}

// ── Per-image polling ────────────────────────────────────────────────────────

function syncPolls(images) {
  const processingIds = new Set();
  for (const img of images) {
    if (img.border_status === 'processing') {
      processingIds.add(img.id);
      if (!activePolls.has(img.id)) {
        activePolls.set(img.id, setInterval(() => pollOneImage(img.id), 3000));
      }
    }
  }
  for (const [id, timer] of activePolls) {
    if (!processingIds.has(id)) {
      clearInterval(timer);
      activePolls.delete(id);
    }
  }
}

async function pollOneImage(id) {
  const resp = await fetch(`/api/ingest2/recent?hours=${currentHours}&id=${id}`);
  const images = await resp.json();
  if (images.length === 0) {
    clearInterval(activePolls.get(id));
    activePolls.delete(id);
    return;
  }
  const img = images[0];
  const card = document.querySelector(`#grid .img-card[data-id="${id}"]`);
  if (card) updateCardEl(card, img);
  if (img.border_status !== 'processing') {
    clearInterval(activePolls.get(id));
    activePolls.delete(id);
  }
}

// ── Discovery poll (slow — finds new images uploaded while page is open) ─────

async function discoverNewImages() {
  const resp = await fetch(`/api/ingest2/recent?hours=${currentHours}`);
  const images = await resp.json();
  const grid = document.getElementById('grid');
  let foundNew = false;
  for (const img of images) {
    if (!grid.querySelector(`.img-card[data-id="${img.id}"]`)) {
      grid.prepend(createCardEl(img));
      foundNew = true;
      if (img.border_status === 'processing' && !activePolls.has(img.id)) {
        activePolls.set(img.id, setInterval(() => pollOneImage(img.id), 3000));
      }
    }
  }
  if (foundNew) updateSummary(images);
}

function escapeHtml(s) {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}


function fmtTokens(n) {
  if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + 'M';
  if (n >= 1000) return Math.round(n / 1000) + 'K';
  return String(n);
}

async function loadUsageStats() {
  const resp = await fetch(`/api/ingest2/usage-stats?hours=${currentHours}`);
  const data = await resp.json();
  const box = document.getElementById('usage-box');
  const u = data.usage;
  const cost = data.estimated_cost_usd;

  const parts = [];
  if (u.haiku.input + u.haiku.output > 0)
    parts.push(`${fmtTokens(u.haiku.input + u.haiku.output)} haiku`);
  if (u.sonnet.input + u.sonnet.output > 0)
    parts.push(`${fmtTokens(u.sonnet.input + u.sonnet.output)} sonnet`);
  if (u.opus.input + u.opus.output > 0)
    parts.push(`${fmtTokens(u.opus.input + u.opus.output)} opus`);

  if (parts.length === 0) {
    box.innerHTML = '';
    return;
  }
  box.innerHTML = `<span class="usage-cost">~$${cost.toFixed(4)}</span><br>${parts.join(' · ')}`;
}

loadRecent();
loadUsageStats();
discoveryTimer = setInterval(discoverNewImages, 20000);
setInterval(loadUsageStats, 30000);
</script>
</body>
</html>
