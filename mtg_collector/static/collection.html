<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Collection Browser</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/keyrune@latest/css/keyrune.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mana-font@latest/css/mana.min.css">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: #1a1a2e;
  color: #e0e0e0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  min-height: 100vh;
}

header {
  background: #16213e;
  padding: 16px 24px;
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
  border-bottom: 2px solid #0f3460;
}

header h1 {
  font-size: 1.3rem;
  color: #e94560;
  margin-right: 16px;
  white-space: nowrap;
}

.controls {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

input[type="text"], select, button {
  padding: 8px 14px;
  border: 1px solid #0f3460;
  border-radius: 6px;
  background: #1a1a2e;
  color: #e0e0e0;
  font-size: 0.9rem;
}

input[type="text"]:focus, select:focus { outline: 2px solid #e94560; }

button {
  background: #e94560;
  border-color: #e94560;
  color: #fff;
  font-weight: 600;
  cursor: pointer;
}

button:hover { background: #c73651; }

button.secondary {
  background: #333;
  border-color: #555;
}
button.secondary:hover { background: #e94560; border-color: #e94560; }
button.secondary.active { background: #0f3460; border-color: #e94560; }

#search-input { width: 220px; }

#status {
  font-size: 0.85rem;
  color: #888;
  margin-left: auto;
}

/* Layout */
.layout {
  display: flex;
  min-height: calc(100vh - 70px);
}

/* Sidebar */
.sidebar {
  width: 260px;
  background: #16213e;
  border-right: 1px solid #0f3460;
  padding: 16px;
  flex-shrink: 0;
  overflow-y: auto;
}

.sidebar.collapsed { display: none; }

.sidebar h3 {
  font-size: 0.85rem;
  color: #888;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin: 16px 0 8px;
}

.sidebar h3:first-child { margin-top: 0; }

/* Pill groups */
.pill-group { display: flex; flex-wrap: wrap; gap: 4px; }
.pill-group input[type="checkbox"] { display: none; }
.pill-group label {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 12px;
  border: 1px solid #0f3460;
  border-radius: 20px;
  font-size: 0.8rem;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
  user-select: none;
}
.pill-group label:hover { border-color: #e94560; }
.pill-group input[type="checkbox"]:checked + label {
  background: #e94560;
  border-color: #e94560;
  color: #fff;
}

/* Color pill mana icons */
.pill-group label .ms { font-size: 1rem; }

/* Rarity dots */
.rarity-dot {
  display: inline-block;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

/* Multi-select search component */
.multi-select-wrap { position: relative; }
.multi-search-input {
  width: 100%;
  padding: 6px 10px;
  border: 1px solid #0f3460;
  border-radius: 4px;
  background: #1a1a2e;
  color: #e0e0e0;
  font-size: 0.85rem;
}
.multi-search-input:focus { outline: 2px solid #e94560; }
.multi-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  max-height: 200px;
  overflow-y: auto;
  background: #1a1a2e;
  border: 1px solid #0f3460;
  border-top: none;
  border-radius: 0 0 4px 4px;
  z-index: 50;
  list-style: none;
}
.multi-dropdown.open { display: block; }
.multi-dropdown li {
  padding: 6px 10px;
  font-size: 0.85rem;
  cursor: pointer;
}
.multi-dropdown li:hover { background: #0f3460; }
.multi-dropdown li.selected { color: #e94560; }
.selected-pills {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-top: 4px;
}
.selected-pill {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  background: #0f3460;
  border: 1px solid #e94560;
  border-radius: 12px;
  font-size: 0.75rem;
  color: #e0e0e0;
}
.selected-pill .remove-pill {
  cursor: pointer;
  color: #e94560;
  font-weight: bold;
  font-size: 0.85rem;
  line-height: 1;
}
.selected-pill .remove-pill:hover { color: #fff; }

/* Range filter inputs */
.range-row {
  display: flex;
  gap: 6px;
  align-items: center;
}
.range-row input[type="number"] {
  width: 60px;
  padding: 4px 6px;
  border: 1px solid #0f3460;
  border-radius: 4px;
  background: #1a1a2e;
  color: #e0e0e0;
  font-size: 0.8rem;
}
.range-row input[type="number"]:focus { outline: 2px solid #e94560; }
.range-row span { font-size: 0.8rem; color: #888; }

/* Main content */
.main {
  flex: 1;
  padding: 24px;
  overflow-y: auto;
}

/* Table view */
.collection-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

.collection-table th {
  text-align: left;
  padding: 8px 12px;
  border-bottom: 2px solid #0f3460;
  color: #888;
  font-weight: 600;
  cursor: pointer;
  user-select: none;
  white-space: nowrap;
}

.collection-table th:hover { color: #e94560; }
.collection-table th.sorted { color: #e94560; }

.collection-table td {
  padding: 8px 12px;
  border-bottom: 1px solid #0f346033;
  vertical-align: middle;
}

.collection-table tr:hover { background: rgba(15, 52, 96, 0.2); }
.collection-table tr { cursor: pointer; }

.card-cell {
  display: flex;
  align-items: center;
  gap: 10px;
}

.card-thumb {
  width: 146px;
  height: 44px;
  object-fit: cover;
  object-position: top center;
  border-radius: 4px;
  flex-shrink: 0;
}

.card-info { display: flex; flex-direction: column; gap: 2px; }
.card-name { font-weight: 500; }
.card-tags { display: flex; gap: 3px; flex-wrap: wrap; }

.type-cell {
  max-width: 160px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 1.3;
}
.type-sub {
  display: block;
  font-size: 0.8em;
  color: #777;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.mana-cost { white-space: nowrap; }
.mana-cost .ms { font-size: 0.85rem; }
.mana-line { display: block; white-space: nowrap; }

.card-face { display: block; }
.card-face + .card-face { margin-top: 2px; }

.set-cell { display: flex; align-items: center; gap: 6px; white-space: nowrap; }
.set-cell .ss {
  font-size: 1.3em;
  width: 26px;
  height: 26px;
  line-height: 26px;
  text-align: center;
  background: #efefef;
  border-radius: 5px;
}

.price-cell {
  display: inline-flex;
  flex-direction: column;
  gap: 3px;
}
.price-cell .badge {
  font-size: 0.75rem;
  padding: 2px 6px;
}

/* Card grid */
.card-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.sheet-card {
  width: 264px;
  position: relative;
  cursor: pointer;
}

.sheet-card-img-wrap {
  width: 264px;
  aspect-ratio: 488 / 680;
  border-radius: 8px;
  position: relative;
  overflow: hidden;
  --rarity-color: #111;
  --set-color: #111;
  background: linear-gradient(to bottom, var(--rarity-color), var(--set-color));
}

.sheet-card-img-wrap img {
  position: absolute;
  top: 2px; left: 2px;
  width: calc(100% - 4px);
  height: calc(100% - 4px);
  object-fit: cover;
  border-radius: 6px;
  image-rendering: high-quality;
}

.sheet-card-img-wrap.foil::before {
  content: "";
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: repeating-linear-gradient(
    135deg,
    rgba(255,0,0,0.08),
    rgba(255,165,0,0.08) 5%,
    rgba(255,255,0,0.08) 10%,
    rgba(0,200,0,0.08) 15%,
    rgba(0,140,255,0.08) 20%,
    rgba(130,0,255,0.08) 25%,
    rgba(255,0,200,0.08) 30%,
    rgba(255,0,0,0.08) 33.33%
  );
  mix-blend-mode: color;
  pointer-events: none;
  z-index: 1;
}

.sheet-card-img-wrap.foil::after {
  content: "";
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background:
    linear-gradient(135deg, transparent 46%, rgba(255,255,255,0.12) 49%, rgba(255,255,255,0.12) 51%, transparent 54%)
    100% 100% / 240% 240%;
  pointer-events: none;
  z-index: 2;
  animation: foil-streak 3s ease-in-out infinite;
}

@keyframes foil-streak {
  0% { background-position: 100% 100%; }
  15%, 100% { background-position: 0 0; }
}

.sheet-card-info {
  display: flex;
  gap: 3px;
  flex-wrap: wrap;
  margin-top: 2px;
}

.qty-badge {
  position: absolute;
  top: 6px; right: 6px;
  background: rgba(233, 69, 96, 0.9);
  color: #fff;
  font-size: 0.75rem;
  font-weight: 700;
  padding: 2px 7px;
  border-radius: 10px;
  z-index: 3;
}

.badge {
  font-size: 0.6rem;
  font-weight: 700;
  padding: 1px 5px;
  border-radius: 3px;
  text-transform: uppercase;
}

.badge.treatment { background: linear-gradient(135deg, #0f2a3e, #0f3460); border: 1px solid #1a5276; color: #7ec8e3; }
a.badge.link { background: #333; border: 1px solid #555; color: #aaa; text-decoration: none; font-variant-numeric: tabular-nums; }
a.badge.link:hover { color: #fff; background: #555; border-color: #777; }

.foil-tag, .treat-tag, .promo-tag {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 0.7rem;
  font-weight: 700;
}

.foil-tag {
  background: linear-gradient(135deg, #2a1a3e, #1a2a4e);
  border: 1px solid #5c2d91;
  color: #c8a0e8;
}

.treat-tag {
  background: linear-gradient(135deg, #0f2a3e, #0f3460);
  border: 1px solid #1a5276;
  color: #7ec8e3;
}

.promo-tag {
  background: linear-gradient(135deg, #3e2a0f, #4e3a1a);
  border: 1px solid #76521a;
  color: #e3c87e;
}

.card-tag {
  padding: 1px 3px;
  font-size: 0.6rem;
  vertical-align: middle;
  margin-left: 0px;
}

.empty-state {
  color: #555;
  font-style: italic;
  font-size: 0.9rem;
  padding: 32px;
  text-align: center;
}

/* Zoom overlay */
#zoom-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.75);
  z-index: 100;
  justify-content: center;
  align-items: center;
  cursor: pointer;
}

#zoom-overlay.active { display: flex; }

#zoom-overlay img {
  max-height: 85vh;
  max-width: 90vw;
  border-radius: 16px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.8);
}

/* Sort arrow */
.sort-arrow { font-size: 0.7rem; margin-left: 2px; }

/* Sort bar (grid view) */
.sort-bar {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

.sort-btn {
  padding: 4px 10px;
  border: 1px solid #0f3460;
  border-radius: 4px;
  background: #16213e;
  color: #888;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  user-select: none;
  white-space: nowrap;
}

.sort-btn:hover { color: #e94560; border-color: #e94560; }
.sort-btn.active { color: #e94560; border-color: #e94560; background: #1a1a2e; }

@media (max-width: 768px) {
  .sidebar { display: none; }
  .sheet-card { width: 168px; }
  .sheet-card-img-wrap { width: 168px; }
  #search-input { width: 140px; }
}
</style>
<style id="dynamic-settings-style"></style>
</head>
<body>

<header>
  <h1>Collection</h1>
  <div class="controls">
    <input type="text" id="search-input" placeholder="Search cards...">
    <button class="secondary" id="view-table-btn" title="Table view">Table</button>
    <button class="secondary" id="view-grid-btn" title="Grid view">Grid</button>
    <button class="secondary" id="sidebar-toggle-btn" title="Toggle filters">Filters</button>
  </div>
  <div id="status"></div>
</header>

<div class="layout">
  <aside class="sidebar" id="sidebar">
    <h3>Color</h3>
    <div class="pill-group" id="color-filters">
      <input type="checkbox" id="cf-W" value="W"><label for="cf-W"><i class="ms ms-w ms-cost"></i></label>
      <input type="checkbox" id="cf-U" value="U"><label for="cf-U"><i class="ms ms-u ms-cost"></i></label>
      <input type="checkbox" id="cf-B" value="B"><label for="cf-B"><i class="ms ms-b ms-cost"></i></label>
      <input type="checkbox" id="cf-R" value="R"><label for="cf-R"><i class="ms ms-r ms-cost"></i></label>
      <input type="checkbox" id="cf-G" value="G"><label for="cf-G"><i class="ms ms-g ms-cost"></i></label>
      <input type="checkbox" id="cf-C" value="C"><label for="cf-C"><i class="ms ms-c ms-cost"></i></label>
    </div>

    <h3>Rarity</h3>
    <div class="pill-group" id="rarity-filters">
      <input type="checkbox" id="rf-common" value="common"><label for="rf-common"><span class="rarity-dot" style="background:#111"></span> C</label>
      <input type="checkbox" id="rf-uncommon" value="uncommon"><label for="rf-uncommon"><span class="rarity-dot" style="background:#6a6a6a"></span> U</label>
      <input type="checkbox" id="rf-rare" value="rare"><label for="rf-rare"><span class="rarity-dot" style="background:#c9a816"></span> R</label>
      <input type="checkbox" id="rf-mythic" value="mythic"><label for="rf-mythic"><span class="rarity-dot" style="background:#d4422a"></span> M</label>
    </div>

    <h3>Set</h3>
    <div class="multi-select-wrap" id="set-filter-wrap">
      <input type="text" class="multi-search-input" id="set-search" placeholder="Search sets..." autocomplete="off">
      <ul class="multi-dropdown" id="set-dropdown"></ul>
      <div class="selected-pills" id="set-pills"></div>
    </div>

    <h3>Type</h3>
    <div class="pill-group" id="type-filters">
      <input type="checkbox" id="tf-creature" value="Creature"><label for="tf-creature">Creature</label>
      <input type="checkbox" id="tf-instant" value="Instant"><label for="tf-instant">Instant</label>
      <input type="checkbox" id="tf-sorcery" value="Sorcery"><label for="tf-sorcery">Sorcery</label>
      <input type="checkbox" id="tf-enchantment" value="Enchantment"><label for="tf-enchantment">Enchantment</label>
      <input type="checkbox" id="tf-artifact" value="Artifact"><label for="tf-artifact">Artifact</label>
      <input type="checkbox" id="tf-planeswalker" value="Planeswalker"><label for="tf-planeswalker">PW</label>
      <input type="checkbox" id="tf-land" value="Land"><label for="tf-land">Land</label>
      <input type="checkbox" id="tf-battle" value="Battle"><label for="tf-battle">Battle</label>
      <input type="checkbox" id="tf-kindred" value="Kindred"><label for="tf-kindred">Kindred</label>
    </div>

    <h3>Subtype</h3>
    <div class="multi-select-wrap" id="subtype-filter-wrap">
      <input type="text" class="multi-search-input" id="subtype-search" placeholder="Search subtypes..." autocomplete="off">
      <ul class="multi-dropdown" id="subtype-dropdown"></ul>
      <div class="selected-pills" id="subtype-pills"></div>
    </div>

    <h3>Mana Value</h3>
    <div class="range-row">
      <input type="number" id="cmc-min" min="0" placeholder="Min">
      <span>&ndash;</span>
      <input type="number" id="cmc-max" min="0" placeholder="Max">
    </div>

    <h3>Finish</h3>
    <div class="pill-group" id="finish-filters">
      <input type="checkbox" id="ff-nonfoil" value="nonfoil"><label for="ff-nonfoil">Nonfoil</label>
      <input type="checkbox" id="ff-foil" value="foil"><label for="ff-foil">Foil</label>
      <input type="checkbox" id="ff-etched" value="etched"><label for="ff-etched">Etched</label>
    </div>

    <h3>Treatment</h3>
    <div class="pill-group" id="badge-filters">
      <input type="checkbox" id="bf-borderless" value="borderless"><label for="bf-borderless">BL</label>
      <input type="checkbox" id="bf-showcase" value="showcase"><label for="bf-showcase">SC</label>
      <input type="checkbox" id="bf-extendedart" value="extendedart"><label for="bf-extendedart">EA</label>
      <input type="checkbox" id="bf-fullart" value="fullart"><label for="bf-fullart">FA</label>
      <input type="checkbox" id="bf-promo" value="promo"><label for="bf-promo">Promo</label>
    </div>

    <h3>Price (USD)</h3>
    <div class="range-row">
      <input type="number" id="price-min" min="0" step="0.01" placeholder="Min">
      <span>&ndash;</span>
      <input type="number" id="price-max" min="0" step="0.01" placeholder="Max">
    </div>

    <button style="margin-top:16px;width:100%" id="clear-filters-btn">Clear Filters</button>
  </aside>

  <div class="main" id="main">
    <div class="empty-state">Loading collection...</div>
  </div>
</div>

<div id="zoom-overlay"><img id="zoom-img" src="" alt=""></div>

<script>
const searchInput = document.getElementById('search-input');
const viewTableBtn = document.getElementById('view-table-btn');
const viewGridBtn = document.getElementById('view-grid-btn');
const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
const sidebar = document.getElementById('sidebar');
const main = document.getElementById('main');
const statusEl = document.getElementById('status');
const zoomOverlay = document.getElementById('zoom-overlay');
const zoomImg = document.getElementById('zoom-img');
const clearFiltersBtn = document.getElementById('clear-filters-btn');

// Range inputs
const cmcMinEl = document.getElementById('cmc-min');
const cmcMaxEl = document.getElementById('cmc-max');
const priceMinEl = document.getElementById('price-min');
const priceMaxEl = document.getElementById('price-max');

let currentView = 'table';
let sortOrder = 'asc';
let sortColumn = 'name';
let allCards = [];
let debounceTimer = null;
let _settings = {};

// Multi-select state
let selectedSets = new Map();   // code -> name
let selectedSubtypes = new Set();
let allSetOptions = [];         // [{code, name}]
let allSubtypeOptions = [];     // [string]

const SORT_COLS = [
  { key: 'qty', label: 'Qty' },
  { key: 'name', label: 'Card' },
  { key: 'type', label: 'Type' },
  { key: 'mana', label: 'Cost' },
  { key: 'set', label: 'Set' },
  { key: 'collector_number', label: '#' },
  { key: 'condition', label: 'Cond.' },
  { key: 'price', label: 'Price' },
];

const COL_SORT_MAP = {
  qty: 'qty', name: 'name', type: 'name', mana: 'cmc',
  set: 'set', collector_number: 'collector_number',
  condition: 'name', price: 'price',
};

function handleSortClick(colKey) {
  if (sortColumn === colKey) {
    sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
  } else {
    sortColumn = colKey;
    sortOrder = 'asc';
  }
  fetchCollection();
}

// --- Rarity/set border colors ---
const RARITY_COLORS = {common: '#111', uncommon: '#6a6a6a', rare: '#c9a816', mythic: '#d4422a'};
function getRarityColor(rarity) { return RARITY_COLORS[rarity] || '#111'; }

// --- Zoom ---
zoomOverlay.addEventListener('click', () => zoomOverlay.classList.remove('active'));
function showZoom(imgSrc) {
  zoomImg.src = imgSrc;
  zoomOverlay.classList.add('active');
}

// --- Price badges (for table price column) ---
function buildPriceBadges(card) {
  let html = '';
  const sources = (_settings.price_sources || 'tcg,ck').split(',');
  if (sources.includes('tcg')) {
    const sfPrice = card.tcg_price ? ` $${parseFloat(card.tcg_price).toFixed(2)}` : '';
    html += `<a class="badge link" href="https://scryfall.com/card/${card.set_code.toLowerCase()}/${card.collector_number}" target="_blank" rel="noopener" onclick="event.stopPropagation()">SF${sfPrice}</a>`;
  }
  if (sources.includes('ck')) {
    const ckSearch = encodeURIComponent(card.name.split(' // ')[0]);
    const ckPrice = card.ck_price ? ` $${parseFloat(card.ck_price).toFixed(2)}` : '';
    html += `<a class="badge link" href="https://www.cardkingdom.com/catalog/search?search=header&filter%5Bname%5D=${ckSearch}" target="_blank" rel="noopener" onclick="event.stopPropagation()">CK${ckPrice}</a>`;
  }
  return html;
}

// --- Badge builder (from crack_pack patterns) ---
function buildCardBadges(card) {
  let html = '';
  const sources = (_settings.price_sources || 'tcg,ck').split(',');
  if (sources.includes('tcg') && card.scryfall_id) {
    const sfPrice = card.tcg_price ? ` $${parseFloat(card.tcg_price).toFixed(2)}` : '';
    html += `<a class="badge link" href="https://scryfall.com/card/${card.set_code.toLowerCase()}/${card.collector_number}" target="_blank" rel="noopener" onclick="event.stopPropagation()">SF${sfPrice}</a>`;
  }
  if (sources.includes('ck')) {
    const ckSearch = encodeURIComponent(card.name.split(' // ')[0]);
    const ckPrice = card.ck_price ? ` $${parseFloat(card.ck_price).toFixed(2)}` : '';
    html += `<a class="badge link" href="https://www.cardkingdom.com/catalog/search?search=header&filter%5Bname%5D=${ckSearch}" target="_blank" rel="noopener" onclick="event.stopPropagation()">CK${ckPrice}</a>`;
  }
  const fe = parseJsonField(card.frame_effects);
  if (card.border_color === 'borderless') html += '<span class="badge treatment">BL</span>';
  if (fe.includes('showcase')) html += '<span class="badge treatment">SC</span>';
  if (fe.includes('extendedart')) html += '<span class="badge treatment">EA</span>';
  if (card.full_art) html += '<span class="badge treatment">FA</span>';
  if (card.finish === 'foil') html += '<span class="foil-tag">Foil</span>';
  if (card.finish === 'etched') html += '<span class="foil-tag">Etched</span>';
  return html;
}

function parseJsonField(val) {
  if (!val) return [];
  if (Array.isArray(val)) return val;
  try { return JSON.parse(val); } catch { return []; }
}

function renderMana(cost) {
  if (!cost) return '';
  return cost.replace(/\{([^}]+)\}/g, (_, sym) => {
    const cls = sym.toLowerCase().replace(/\//g, '');
    return `<i class="ms ms-${cls} ms-cost ms-shadow"></i>`;
  });
}

function buildInlineTags(card) {
  let html = '';
  if (card.finish === 'foil') html += '<span class="card-tag foil-tag" title="Foil">F</span>';
  else if (card.finish === 'etched') html += '<span class="card-tag foil-tag" title="Etched foil">E</span>';
  const fe = parseJsonField(card.frame_effects);
  const isBorderless = card.border_color === 'borderless';
  if (isBorderless) html += '<span class="card-tag treat-tag" title="Borderless">BL</span>';
  if (fe.includes('showcase')) html += '<span class="card-tag treat-tag" title="Showcase frame">SC</span>';
  if (fe.includes('extendedart')) html += '<span class="card-tag treat-tag" title="Extended art">EA</span>';
  if (card.full_art && !isBorderless) html += '<span class="card-tag treat-tag" title="Full art">FA</span>';
  if (fe.includes('inverted')) html += '<span class="card-tag treat-tag" title="Inverted frame">IN</span>';
  if (card.promo) html += '<span class="card-tag promo-tag" title="Promo">P</span>';
  return html;
}

// --- Multi-select component ---
function initMultiSelect(config) {
  const searchEl = document.getElementById(config.searchId);
  const dropdownEl = document.getElementById(config.dropdownId);
  const pillsEl = document.getElementById(config.pillsId);

  function renderDropdown(filter) {
    const q = (filter || '').toLowerCase();
    const items = config.getOptions().filter(item => {
      const label = config.getLabel(item).toLowerCase();
      return !q || label.includes(q);
    });
    dropdownEl.innerHTML = '';
    for (const item of items.slice(0, 50)) {
      const li = document.createElement('li');
      const key = config.getKey(item);
      li.textContent = config.getLabel(item);
      if (config.isSelected(key)) li.classList.add('selected');
      li.addEventListener('mousedown', (e) => {
        e.preventDefault();
        config.toggle(key, item);
        renderPills();
        renderDropdown(searchEl.value);
        fetchCollection();
      });
      dropdownEl.appendChild(li);
    }
  }

  function renderPills() {
    pillsEl.innerHTML = '';
    for (const [key, label] of config.getSelected()) {
      const pill = document.createElement('span');
      pill.className = 'selected-pill';
      pill.innerHTML = `${label} <span class="remove-pill">&times;</span>`;
      pill.querySelector('.remove-pill').addEventListener('click', () => {
        config.remove(key);
        renderPills();
        renderDropdown(searchEl.value);
        fetchCollection();
      });
      pillsEl.appendChild(pill);
    }
  }

  searchEl.addEventListener('focus', () => {
    renderDropdown(searchEl.value);
    dropdownEl.classList.add('open');
  });
  searchEl.addEventListener('input', () => {
    renderDropdown(searchEl.value);
    dropdownEl.classList.add('open');
  });
  searchEl.addEventListener('blur', () => {
    setTimeout(() => dropdownEl.classList.remove('open'), 150);
  });

  return { renderPills, renderDropdown };
}

// Set multi-select
const setMultiSelect = initMultiSelect({
  searchId: 'set-search',
  dropdownId: 'set-dropdown',
  pillsId: 'set-pills',
  getOptions: () => allSetOptions,
  getLabel: (item) => `${item.name} (${item.code.toUpperCase()})`,
  getKey: (item) => item.code,
  isSelected: (key) => selectedSets.has(key),
  toggle: (key, item) => {
    if (selectedSets.has(key)) selectedSets.delete(key);
    else selectedSets.set(key, item.name);
  },
  remove: (key) => selectedSets.delete(key),
  getSelected: () => Array.from(selectedSets.entries()).map(([k, v]) => [k, `${v} (${k.toUpperCase()})`]),
});

// Subtype multi-select
const subtypeMultiSelect = initMultiSelect({
  searchId: 'subtype-search',
  dropdownId: 'subtype-dropdown',
  pillsId: 'subtype-pills',
  getOptions: () => allSubtypeOptions,
  getLabel: (item) => item,
  getKey: (item) => item,
  isSelected: (key) => selectedSubtypes.has(key),
  toggle: (key) => {
    if (selectedSubtypes.has(key)) selectedSubtypes.delete(key);
    else selectedSubtypes.add(key);
  },
  remove: (key) => selectedSubtypes.delete(key),
  getSelected: () => Array.from(selectedSubtypes).map(s => [s, s]),
});

// --- View toggle ---
viewTableBtn.addEventListener('click', () => { currentView = 'table'; updateViewButtons(); render(); });
viewGridBtn.addEventListener('click', () => { currentView = 'grid'; updateViewButtons(); render(); });

function updateViewButtons() {
  viewTableBtn.classList.toggle('active', currentView === 'table');
  viewGridBtn.classList.toggle('active', currentView === 'grid');
}
updateViewButtons();

// --- Sidebar toggle ---
sidebarToggleBtn.addEventListener('click', () => {
  sidebar.classList.toggle('collapsed');
  sidebarToggleBtn.classList.toggle('active', !sidebar.classList.contains('collapsed'));
});
sidebarToggleBtn.classList.add('active');

// --- Fetch ---
function getFilterParams() {
  const params = new URLSearchParams();
  const q = searchInput.value.trim();
  if (q) params.set('q', q);
  params.set('sort', COL_SORT_MAP[sortColumn] || 'name');
  params.set('order', sortOrder);

  document.querySelectorAll('#color-filters input:checked').forEach(cb => {
    params.append('filter_color', cb.value);
  });
  document.querySelectorAll('#rarity-filters input:checked').forEach(cb => {
    params.append('filter_rarity', cb.value);
  });
  for (const code of selectedSets.keys()) {
    params.append('filter_set', code);
  }
  document.querySelectorAll('#type-filters input:checked').forEach(cb => {
    params.append('filter_type[]', cb.value);
  });
  for (const st of selectedSubtypes) {
    params.append('filter_subtype[]', st);
  }
  document.querySelectorAll('#finish-filters input:checked').forEach(cb => {
    params.append('filter_finish', cb.value);
  });
  document.querySelectorAll('#badge-filters input:checked').forEach(cb => {
    params.append('filter_badge[]', cb.value);
  });

  const cmcMin = cmcMinEl.value;
  const cmcMax = cmcMaxEl.value;
  if (cmcMin !== '') params.set('filter_cmc_min', cmcMin);
  if (cmcMax !== '') params.set('filter_cmc_max', cmcMax);

  return params.toString();
}

async function fetchCollection() {
  const params = getFilterParams();
  statusEl.textContent = 'Loading...';
  const res = await fetch(`/api/collection?${params}`);
  allCards = await res.json();

  // Client-side price sort if needed
  if (sortColumn === 'price') {
    allCards.sort((a, b) => {
      const pa = parseFloat(a.tcg_price) || 0;
      const pb = parseFloat(b.tcg_price) || 0;
      return sortOrder === 'asc' ? pa - pb : pb - pa;
    });
  }

  // Client-side price filtering
  const pMin = parseFloat(priceMinEl.value);
  const pMax = parseFloat(priceMaxEl.value);
  if (!isNaN(pMin) || !isNaN(pMax)) {
    allCards = allCards.filter(card => {
      const price = parseFloat(card.tcg_price) || 0;
      if (!isNaN(pMin) && price < pMin) return false;
      if (!isNaN(pMax) && price > pMax) return false;
      return true;
    });
  }

  // Populate set filter options from data
  populateSetOptions();
  // Populate subtype options from data
  populateSubtypeOptions();

  statusEl.textContent = `${allCards.length} entries, ${allCards.reduce((s, c) => s + c.qty, 0)} cards`;
  render();
}

function populateSetOptions() {
  const sets = new Map();
  for (const card of allCards) {
    if (!sets.has(card.set_code)) {
      sets.set(card.set_code, card.set_name);
    }
  }
  allSetOptions = Array.from(sets.entries())
    .map(([code, name]) => ({ code, name }))
    .sort((a, b) => a.name.localeCompare(b.name));
}

function populateSubtypeOptions() {
  const subtypes = new Set();
  for (const card of allCards) {
    const tl = card.type_line || '';
    const dashIdx = tl.indexOf(' \u2014 ');
    if (dashIdx !== -1) {
      const sub = tl.substring(dashIdx + 3);
      for (const s of sub.split(/\s+/)) {
        if (s) subtypes.add(s);
      }
    }
  }
  allSubtypeOptions = Array.from(subtypes).sort();
}

// --- Render ---
function render() {
  if (currentView === 'table') renderTable();
  else renderGrid();
}

function renderTable() {
  if (allCards.length === 0) {
    main.innerHTML = '<div class="empty-state">No cards found</div>';
    return;
  }

  let html = '<table class="collection-table"><thead><tr>';
  for (const col of SORT_COLS) {
    const isActive = col.key === sortColumn;
    const arrow = isActive ? `<span class="sort-arrow">${sortOrder === 'asc' ? '\u25B2' : '\u25BC'}</span>` : '';
    html += `<th class="${isActive ? 'sorted' : ''}" data-col="${col.key}">${col.label}${arrow}</th>`;
  }
  html += '</tr></thead><tbody>';

  const CONDITION_ABBREV = {
    'Near Mint': 'NM', 'Lightly Played': 'LP', 'Moderately Played': 'MP',
    'Heavily Played': 'HP', 'Damaged': 'D',
  };

  for (const card of allCards) {
    const imgFull = card.image_uri || '';
    const imgSrc = imgFull.replace('/normal/', '/small/');
    const rawMana = card.mana_cost || '';
    const isDfc = card.name.includes(' // ');
    let nameHtml, manaHtml;
    if (isDfc) {
      const names = card.name.split(' // ');
      const manas = rawMana.split(' // ');
      nameHtml = names.map(n => `<span class="card-face"><span class="card-name">${n}</span></span>`).join('');
      manaHtml = manas.map(m => `<span class="mana-line">${renderMana(m)}</span>`).join('');
    } else {
      nameHtml = `<span class="card-name">${card.name}</span>`;
      manaHtml = renderMana(rawMana);
    }
    const priceBadges = buildPriceBadges(card);
    const condAbbrev = CONDITION_ABBREV[card.condition] || card.condition;
    const setCode = card.set_code.toLowerCase();
    const rarityClass = `ss-${card.rarity || 'common'}`;
    const setName = card.set_name || card.set_code.toUpperCase();
    const setIcon = `<i class="ss ss-${setCode} ${rarityClass} ss-grad ss-fw"></i>`;
    const tags = buildInlineTags(card);

    html += `<tr data-img="${imgFull}" onclick="showZoom('${imgFull}')">`;
    html += `<td>${card.qty}</td>`;
    html += `<td><div class="card-cell">${imgSrc ? `<img class="card-thumb" src="${imgSrc}" loading="lazy">` : ''}<div class="card-info">${nameHtml}${tags ? `<div class="card-tags">${tags}</div>` : ''}</div></div></td>`;
    const fullType = card.type_line || '';
    const typeParts = fullType.split(' \u2014 ');
    const mainType = typeParts[0].replace(/Legendary /g, 'Lgdry. ');
    const subType = typeParts[1] || '';
    html += `<td class="type-cell" title="${fullType}">${mainType}${subType ? `<span class="type-sub">${subType}</span>` : ''}</td>`;
    html += `<td class="mana-cost">${manaHtml}</td>`;
    html += `<td title="${setName}"><div class="set-cell">${setIcon} ${card.set_code.toUpperCase()}</div></td>`;
    html += `<td>${(card.collector_number || '').padStart(4, '0')}</td>`;
    html += `<td>${condAbbrev}</td>`;
    html += `<td class="price-cell">${priceBadges}</td>`;
    html += '</tr>';
  }

  html += '</tbody></table>';
  main.innerHTML = html;

  // Column header click sorting
  main.querySelectorAll('.collection-table th[data-col]').forEach(th => {
    th.addEventListener('click', () => handleSortClick(th.dataset.col));
  });
}

function renderGrid() {
  if (allCards.length === 0) {
    main.innerHTML = '<div class="empty-state">No cards found</div>';
    return;
  }

  // Sort bar
  const bar = document.createElement('div');
  bar.className = 'sort-bar';
  for (const col of SORT_COLS) {
    const btn = document.createElement('span');
    btn.className = 'sort-btn' + (col.key === sortColumn ? ' active' : '');
    const arrow = col.key === sortColumn ? ` ${sortOrder === 'asc' ? '\u25B2' : '\u25BC'}` : '';
    btn.textContent = col.label + arrow;
    btn.addEventListener('click', () => handleSortClick(col.key));
    bar.appendChild(btn);
  }

  const grid = document.createElement('div');
  grid.className = 'card-grid';

  for (const card of allCards) {
    const cardEl = document.createElement('div');
    cardEl.className = 'sheet-card';

    const rarityColor = getRarityColor(card.rarity);
    const foilClass = (card.finish === 'foil' || card.finish === 'etched') ? ' foil' : '';
    const badges = buildCardBadges(card);
    const qtyBadge = card.qty > 1 ? `<span class="qty-badge">${card.qty}x</span>` : '';

    cardEl.innerHTML = `
      <div class="sheet-card-img-wrap${foilClass}" style="--rarity-color:${rarityColor};--set-color:#111">
        <img src="${card.image_uri || ''}" alt="${card.name}" loading="lazy">
        ${qtyBadge}
      </div>
      <div class="sheet-card-info">${badges}</div>
    `;
    cardEl.addEventListener('click', () => showZoom(card.image_uri));
    grid.appendChild(cardEl);
  }

  main.innerHTML = '';
  main.appendChild(bar);
  main.appendChild(grid);
}

// --- Event listeners ---
searchInput.addEventListener('input', () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(fetchCollection, 300);
});

document.querySelectorAll('#color-filters input, #rarity-filters input, #finish-filters input, #badge-filters input, #type-filters input').forEach(cb => {
  cb.addEventListener('change', fetchCollection);
});

// CMC range inputs
cmcMinEl.addEventListener('input', () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(fetchCollection, 300);
});
cmcMaxEl.addEventListener('input', () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(fetchCollection, 300);
});

// Price range inputs (client-side)
priceMinEl.addEventListener('input', () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(fetchCollection, 300);
});
priceMaxEl.addEventListener('input', () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(fetchCollection, 300);
});

clearFiltersBtn.addEventListener('click', () => {
  document.querySelectorAll('#color-filters input, #rarity-filters input, #finish-filters input, #badge-filters input, #type-filters input').forEach(cb => {
    cb.checked = false;
  });
  selectedSets.clear();
  selectedSubtypes.clear();
  setMultiSelect.renderPills();
  subtypeMultiSelect.renderPills();
  searchInput.value = '';
  cmcMinEl.value = '';
  cmcMaxEl.value = '';
  priceMinEl.value = '';
  priceMaxEl.value = '';
  fetchCollection();
});

function applySettings() {
  // Image display: toggle card-thumb between crop and contain
  const style = document.getElementById('dynamic-settings-style');
  let css = '';
  if (_settings.image_display === 'contain') {
    css += '.card-thumb { object-fit: contain !important; object-position: center !important; }\n';
  }
  if (_settings.icon_background === 'none') {
    css += '.set-cell .ss { background: transparent !important; }\n';
  }
  style.textContent = css;
}

// --- Init ---
(async () => {
  const res = await fetch('/api/settings');
  _settings = await res.json();
  applySettings();
  fetchCollection();
})();
</script>

</body>
</html>
