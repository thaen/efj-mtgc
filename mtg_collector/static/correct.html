<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Correct Card - Card Ingest</title>
<link href="https://cdn.jsdelivr.net/npm/keyrune@latest/css/keyrune.min.css" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: #1a1a2e;
  color: #e0e0e0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  min-height: 100vh;
}
header {
  background: #16213e;
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  border-bottom: 2px solid #0f3460;
}
header h1 { font-size: 1.1rem; color: #e94560; }
header a { color: #888; text-decoration: none; font-size: 0.8rem; }
header a:hover { color: #e94560; }

button {
  padding: 8px 16px;
  border: 1px solid #0f3460;
  border-radius: 6px;
  background: #e94560;
  border-color: #e94560;
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  font-size: 0.9rem;
}
button:hover { background: #c73651; }
button:disabled { opacity: 0.5; cursor: not-allowed; }
button.secondary { background: #333; border-color: #555; }
button.secondary:hover { background: #444; }

.card-block {
  margin: 12px 16px;
  background: #16213e;
  border: 1px solid #0f3460;
  border-radius: 8px;
  overflow: hidden;
}

.card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: #0d1117;
  border-bottom: 1px solid #0f3460;
}
.card-header .crop-thumb {
  width: 140px;
  height: 196px;
  background: #0d1117;
  border-radius: 4px;
  overflow: hidden;
  flex-shrink: 0;
  position: relative;
  cursor: zoom-in;
}
.card-header .crop-thumb img {
  position: absolute;
  transform-origin: 0 0;
}
.card-header .card-meta {
  flex: 1;
  min-width: 0;
}
.card-header .card-meta h3 {
  color: #e94560;
  font-size: 0.95rem;
  margin-bottom: 2px;
}
.card-header .card-meta .meta-line {
  font-size: 0.8rem;
  color: #888;
}
.card-header .card-meta .image-source {
  font-size: 0.7rem;
  color: #555;
  margin-top: 2px;
}

/* Current identification */
.current-card {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-bottom: 1px solid #0f3460;
  background: rgba(76, 175, 80, 0.06);
}
.current-card img {
  width: 60px;
  height: 84px;
  object-fit: cover;
  border-radius: 4px;
  flex-shrink: 0;
}
.current-card .card-details { flex: 1; min-width: 0; }
.current-card .card-name { font-weight: 600; font-size: 0.9rem; }
.current-card .card-set { font-size: 0.8rem; color: #888; margin-top: 2px; }
.current-card .card-price {
  font-size: 0.8rem; color: #4caf50;
  background: rgba(76, 175, 80, 0.12);
  padding: 2px 8px; border-radius: 4px;
  flex-shrink: 0;
}
.current-label {
  font-size: 0.7rem;
  color: #4caf50;
  font-weight: 600;
  text-transform: uppercase;
  padding: 6px 12px 0;
}

.actions-col {
  display: flex;
  flex-direction: column;
  gap: 4px;
  flex-shrink: 0;
  align-items: flex-end;
}
.finish-select {
  padding: 4px 8px;
  border: 1px solid #0f3460;
  border-radius: 4px;
  background: #1a1a2e;
  color: #e0e0e0;
  font-size: 0.8rem;
}

.search-row {
  display: flex;
  gap: 6px;
  padding: 6px 12px;
  border-bottom: 1px solid #0f3460;
}
.search-row input {
  flex: 1;
  padding: 5px 8px;
  border-radius: 4px;
  border: 1px solid #0f3460;
  background: #0d1117;
  color: #e0e0e0;
  font-size: 0.85rem;
}
.search-row button {
  padding: 5px 12px;
  font-size: 0.8rem;
}

.candidates-list {
  max-height: 1600px;
  overflow-y: auto;
  padding: 4px;
}
.candidate-row {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 3px 6px;
  border: 2px solid transparent;
  border-radius: 5px;
  margin-bottom: 2px;
  cursor: pointer;
  transition: border-color 0.15s, background 0.15s;
}
.candidate-row:hover { background: #1a1a3e; border-color: #0f3460; }
.candidate-row.selected { border-color: #e94560; background: #1a1a3e; }

.candidate-row .set-icon {
  font-size: 1.8rem;
  width: 42px; height: 42px; line-height: 42px;
  text-align: center; flex-shrink: 0;
  background: #efefef; border-radius: 4px;
}
.candidate-row .card-name {
  font-weight: 600; font-size: 0.8rem;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  flex: 1; min-width: 0;
}
.candidate-row .card-set-name {
  font-size: 0.7rem; color: #888;
  white-space: nowrap; flex-shrink: 0;
  max-width: 160px; overflow: hidden; text-overflow: ellipsis;
}
.candidate-row .card-price {
  font-size: 0.65rem; color: #4caf50;
  background: rgba(76, 175, 80, 0.12);
  padding: 2px 5px; border-radius: 3px;
  flex-shrink: 0; white-space: nowrap;
}
.candidate-row .card-img-crop {
  width: 110px; height: 50px;
  object-fit: cover; object-position: top center;
  border-radius: 3px; flex-shrink: 0;
}

/* Grid mode */
.candidates-list.grid-mode {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 4px;
}
.candidates-list.grid-mode .candidate-row {
  flex-direction: column; padding: 3px; gap: 3px; align-items: center;
  position: relative;
}
.candidates-list.grid-mode .candidate-row .set-icon {
  position: absolute; top: 3px; left: 3px; z-index: 1;
  font-size: 1.2rem; width: 28px; height: 28px; line-height: 28px;
  border: 2px solid #0f3460;
}
.candidates-list.grid-mode .card-img-grid {
  width: 100%; aspect-ratio: 63 / 44;
  object-fit: cover; object-position: top center; border-radius: 3px;
}

.spinner {
  display: inline-block;
  width: 14px; height: 14px;
  border: 2px solid #555;
  border-top-color: #e94560;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  vertical-align: middle;
  margin-right: 6px;
}
@keyframes spin { to { transform: rotate(360deg); } }

.photo-modal {
  position: fixed;
  inset: 0;
  z-index: 1000;
  background: rgba(0,0,0,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: zoom-out;
}
.photo-modal img {
  max-width: 95vw;
  max-height: 95vh;
  object-fit: contain;
  border-radius: 6px;
}

.success-banner {
  margin: 12px 16px;
  padding: 12px 16px;
  background: rgba(76, 175, 80, 0.15);
  border: 1px solid #4caf50;
  border-radius: 8px;
  text-align: center;
  font-size: 0.9rem;
}
.success-banner a { color: #e94560; }

.loading-state {
  text-align: center;
  padding: 60px 24px;
  color: #888;
}
</style>
<style id="dynamic-settings-style"></style>
</head>
<body>

<header>
  <h1><a href="/" style="color:inherit;text-decoration:none">Correct Card</a></h1>
  <a href="/">Home</a>
  <a href="/recent">Recent</a>
  <a href="/disambiguate">Disambiguate</a>
</header>

<div id="loading" class="loading-state">Loading...</div>
<div id="content" style="display:none"></div>
<div id="success" class="success-banner" style="display:none"></div>

<script>
let _settings = {};
let _selectedCandidate = null;
let _imageId, _cardIdx;

const KEYRUNE_FALLBACKS = {
  tsb: 'tsp', pspm: 'spm', cst: 'csp',
};
function keyruneSetCode(code) {
  const lc = (code || '').toLowerCase();
  return KEYRUNE_FALLBACKS[lc] || lc;
}

function applySettings() {
  const style = document.getElementById('dynamic-settings-style');
  let css = '';
  if (_settings.image_display === 'contain') {
    css += '.card-img-crop { object-fit: contain !important; object-position: center !important; }\n';
    css += '.card-img-grid { object-fit: contain !important; object-position: center !important; }\n';
  }
  if (_settings.icon_background === 'none') {
    css += '.candidate-row .set-icon { color: transparent !important; }\n';
  }
  style.textContent = css;
}
fetch('/api/settings').then(r => r.json()).then(s => { _settings = s; applySettings(); });

function escapeHtml(s) {
  return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function showPhotoModal(imageSrc) {
  const modal = document.createElement('div');
  modal.className = 'photo-modal';
  modal.innerHTML = `<img src="${imageSrc}">`;
  modal.addEventListener('click', () => modal.remove());
  document.body.appendChild(modal);
}

async function init() {
  const params = new URLSearchParams(window.location.search);
  _imageId = parseInt(params.get('image_id'));
  _cardIdx = parseInt(params.get('card_idx'));

  const resp = await fetch(`/api/ingest2/images/${_imageId}`);
  const img = await resp.json();

  const disambiguated = img.disambiguated || [];
  const matches = img.scryfall_matches || [];
  const claude = img.claude_result || [];
  const crops = img.crops || [];

  const currentSid = disambiguated[_cardIdx];
  const candidates = matches[_cardIdx] || [];
  const claudeCard = claude[_cardIdx] || {};
  const crop = crops[_cardIdx] || null;

  // Find current card in candidates
  const currentCard = candidates.find(c => c.scryfall_id === currentSid) || {};

  document.getElementById('loading').style.display = 'none';
  const content = document.getElementById('content');
  content.style.display = '';

  // Claude metadata
  const metaParts = [];
  if (claudeCard.type) metaParts.push(claudeCard.type);
  if (claudeCard.set_code) metaParts.push(`Set: ${claudeCard.set_code.toUpperCase()}`);
  if (claudeCard.collector_number) metaParts.push(`#${claudeCard.collector_number}`);
  if (claudeCard.artist) metaParts.push(`Art: ${claudeCard.artist}`);

  // Current card details
  const currentImgUri = (currentCard.image_uri || '').replace('/small/', '/normal/');
  const currentRarity = currentCard.rarity ? currentCard.rarity.charAt(0).toUpperCase() + currentCard.rarity.slice(1) : '';
  const currentCn = currentCard.collector_number ? `#${currentCard.collector_number}` : '';
  const currentMeta = [currentRarity, currentCn].filter(Boolean).join(' \u00b7 ');
  const currentPriceHtml = currentCard.price ? `<span class="card-price">$${currentCard.price}</span>` : '';

  const imgSrc = `/api/ingest/image/${img.stored_name}`;

  content.innerHTML = `
    <div class="card-block">
      <div class="card-header">
        <div class="crop-thumb" id="crop-thumb"></div>
        <div class="card-meta">
          <h3>${escapeHtml(claudeCard.name || 'Unknown')}</h3>
          <div class="meta-line">${escapeHtml(metaParts.join(' | '))}</div>
          <div class="image-source">${escapeHtml(img.filename || img.stored_name)}</div>
        </div>
        <div class="actions-col">
          <div style="display:flex;gap:4px;">
            <button id="confirm-btn" disabled>Confirm Correction</button>
            <select class="finish-select" id="finish-select">
              <option value="nonfoil">Nonfoil</option>
              <option value="foil">Foil</option>
              <option value="etched">Etched</option>
            </select>
          </div>
        </div>
      </div>
      <div class="current-label">Current identification</div>
      <div class="current-card">
        ${currentImgUri ? `<img src="${currentImgUri}" loading="lazy">` : `<div style="width:60px;height:84px;background:#0d1117;border-radius:4px;flex-shrink:0;"></div>`}
        <div class="card-details">
          <div class="card-name">${escapeHtml(currentCard.name || claudeCard.name || 'Unknown')}</div>
          <div class="card-set">${escapeHtml(currentCard.set_name || '')}${currentCard.set_code ? ` (${currentCard.set_code.toUpperCase()})` : ''}</div>
          ${currentMeta ? `<div style="font-size:0.7rem;color:#666;margin-top:2px;">${escapeHtml(currentMeta)}</div>` : ''}
        </div>
        ${currentPriceHtml}
      </div>
      <div class="search-row">
        <input type="text" id="search-input" placeholder="Search by card name..." value="${escapeHtml(claudeCard.name || currentCard.name || '')}">
        <button class="secondary" id="search-btn">Search</button>
      </div>
      <div class="candidates-list" id="candidates"></div>
    </div>
  `;

  // Set up crop thumbnail
  setupCropThumb(crop, imgSrc);

  // Render candidates (excluding current)
  renderCandidates(candidates);

  // Event listeners
  document.getElementById('confirm-btn').addEventListener('click', confirmCorrection);
  document.getElementById('search-btn').addEventListener('click', doSearch);
  document.getElementById('search-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') doSearch();
  });
}

function setupCropThumb(crop, imgSrc) {
  const container = document.getElementById('crop-thumb');
  if (!container) return;

  const img = document.createElement('img');
  img.src = imgSrc;
  container.appendChild(img);
  container.addEventListener('click', () => showPhotoModal(imgSrc));

  img.onload = () => {
    const cw = container.clientWidth;
    const ch = container.clientHeight;
    if (crop && crop.w > 0 && crop.h > 0) {
      const scale = Math.min(cw / crop.w, ch / crop.h);
      const tx = (cw / 2) - (crop.x + crop.w / 2) * scale;
      const ty = (ch / 2) - (crop.y + crop.h / 2) * scale;
      img.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
    } else {
      const scale = Math.min(cw / img.naturalWidth, ch / img.naturalHeight);
      img.style.transform = `scale(${scale})`;
    }
  };
}

function renderCandidates(candidates) {
  const list = document.getElementById('candidates');
  list.innerHTML = '';
  _selectedCandidate = null;
  document.getElementById('confirm-btn').disabled = true;

  if (!candidates.length) {
    list.innerHTML = '<div style="padding:12px;color:#888;text-align:center;font-size:0.85rem;">No candidates found. Try searching.</div>';
    return;
  }

  list.className = 'candidates-list grid-mode';

  for (const c of candidates) {
    const row = document.createElement('div');
    row.className = 'candidate-row';
    row.dataset.scryfallId = c.scryfall_id;

    const setCode = keyruneSetCode(c.set_code);
    const rarityClass = `ss-${c.rarity || 'common'}`;
    const sources = (_settings.price_sources || 'tcg,ck').split(',');
    const showPrice = sources.includes('tcg') && c.price;

    row.innerHTML = `
      <i class="ss ss-${setCode} ${rarityClass} ss-grad ss-fw set-icon"></i>
      ${c.image_uri ? `<img class="card-img-grid" src="${c.image_uri}" loading="lazy">` : `<div style="width:100%;aspect-ratio:63/88;background:#0d1117;border-radius:3px;"></div>`}
    `;
    row.title = `${c.name} â€” ${c.set_name}${showPrice ? ' ($' + c.price + ')' : ''}`;

    row.addEventListener('click', () => {
      list.querySelectorAll('.candidate-row').forEach(r => r.classList.remove('selected'));
      row.classList.add('selected');
      _selectedCandidate = c;
      document.getElementById('confirm-btn').disabled = false;

      // Auto-set finish
      const finishSel = document.getElementById('finish-select');
      if (c.foil && !(c.finishes || []).includes('nonfoil')) {
        finishSel.value = 'foil';
      } else {
        finishSel.value = 'nonfoil';
      }
    });

    list.appendChild(row);
  }
}

async function doSearch() {
  const input = document.getElementById('search-input');
  const query = input.value.trim();
  if (!query) return;

  const btn = document.getElementById('search-btn');
  btn.disabled = true;
  btn.textContent = '...';

  const resp = await fetch('/api/ingest2/search-card', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ image_id: _imageId, card_idx: _cardIdx, query }),
  });
  const data = await resp.json();

  btn.disabled = false;
  btn.textContent = 'Search';

  renderCandidates(data.candidates || []);
}

async function confirmCorrection() {
  if (!_selectedCandidate) return;

  const btn = document.getElementById('confirm-btn');
  btn.disabled = true;
  btn.textContent = '...';

  const finish = document.getElementById('finish-select').value;

  const resp = await fetch('/api/ingest2/correct', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      image_id: _imageId,
      card_idx: _cardIdx,
      scryfall_id: _selectedCandidate.scryfall_id,
      finish,
    }),
  });
  const data = await resp.json();

  if (data.ok) {
    document.getElementById('content').style.display = 'none';
    const success = document.getElementById('success');
    success.style.display = '';
    success.innerHTML = `Corrected to <strong>${escapeHtml(data.name)}</strong> (${escapeHtml(data.set_code.toUpperCase())}). <a href="/recent">Back to Recent</a>`;
  } else {
    btn.disabled = false;
    btn.textContent = 'Confirm Correction';
    alert(data.error || 'Correction failed');
  }
}

init();
</script>
</body>
</html>
